<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Splits â€“ ×—×œ×•×§×ª ×ª×©×œ×•××™×</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary:       #4f46e5;
      --primary-light: #818cf8;
      --primary-dark:  #3730a3;
      --success:       #10b981;
      --danger:        #ef4444;
      --bg:            #f1f5f9;
      --card:          #ffffff;
      --text:          #1e293b;
      --text-light:    #64748b;
      --border:        #e2e8f0;
      --shadow:        0 1px 3px rgba(0,0,0,.10), 0 1px 2px rgba(0,0,0,.06);
      --shadow-md:     0 4px 6px -1px rgba(0,0,0,.10), 0 2px 4px -1px rgba(0,0,0,.06);
      --radius:        14px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      direction: rtl;
    }

    .screen { display: none; }
    .screen.active { display: block; }

    #home-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .logo { font-size: 56px; margin-bottom: 6px; }
    .app-title { font-size: 36px; font-weight: 900; color: var(--primary); margin-bottom: 6px; letter-spacing: -1px; }
    .app-subtitle { font-size: 15px; color: var(--text-light); margin-bottom: 40px; text-align: center; }

    .home-card { background: var(--card); border-radius: var(--radius); padding: 28px 24px; width: 100%; max-width: 400px; box-shadow: var(--shadow-md); }

    .home-toggle { display: flex; background: var(--bg); border-radius: 10px; padding: 4px; margin-bottom: 24px; }
    .home-toggle button { flex: 1; padding: 9px; border: none; background: none; cursor: pointer; border-radius: 7px; font-size: 14px; font-weight: 600; color: var(--text-light); transition: all .2s; }
    .home-toggle button.active { background: var(--card); color: var(--primary); box-shadow: var(--shadow); }

    .form-group { margin-bottom: 14px; }
    label { display: block; font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 5px; }
    input, select { width: 100%; padding: 11px 14px; border: 1.5px solid var(--border); border-radius: 9px; font-size: 15px; color: var(--text); background: var(--bg); transition: border-color .2s, background .2s; direction: rtl; font-family: inherit; }
    input:focus, select:focus { outline: none; border-color: var(--primary); background: #fff; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 11px 20px; border: none; border-radius: 9px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all .18s; font-family: inherit; }
    .btn-primary  { background: var(--primary); color: #fff; width: 100%; }
    .btn-primary:hover  { background: var(--primary-dark); }
    .btn-secondary { background: var(--bg); color: var(--text); border: 1.5px solid var(--border); }
    .btn-success  { background: var(--success); color: #fff; }
    .btn-danger   { background: var(--danger);  color: #fff; }
    .btn-sm { padding: 7px 14px; font-size: 13px; }
    .btn-ghost { background: none; border: none; cursor: pointer; color: var(--text-light); padding: 6px; border-radius: 7px; font-family: inherit; transition: background .15s; }
    .btn-ghost:hover { background: var(--bg); color: var(--danger); }

    #group-screen { max-width: 620px; margin: 0 auto; padding: 14px; }

    .group-header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: #fff; border-radius: var(--radius); padding: 18px 20px; margin-bottom: 14px; display: flex; justify-content: space-between; align-items: center; }
    .group-header h1 { font-size: 20px; font-weight: 800; margin-bottom: 4px; }

    .code-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,.18); border-radius: 20px; padding: 3px 11px; font-size: 13px; font-weight: 700; letter-spacing: 1px; cursor: pointer; transition: background .15s; }
    .code-badge:hover { background: rgba(255,255,255,.28); }

    .leave-btn { background: rgba(255,255,255,.15); border: none; color: #fff; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: background .15s; font-family: inherit; }
    .leave-btn:hover { background: rgba(255,255,255,.28); }

    .summary-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 14px; }
    .summary-card { background: var(--card); border-radius: var(--radius); padding: 14px 10px; text-align: center; box-shadow: var(--shadow); }
    .summary-label { font-size: 11px; color: var(--text-light); font-weight: 600; margin-bottom: 3px; }
    .summary-value { font-size: 20px; font-weight: 800; color: var(--primary); }

    .tabs { display: flex; gap: 4px; background: var(--card); border-radius: 11px; padding: 4px; margin-bottom: 14px; box-shadow: var(--shadow); }
    .tab-btn { flex: 1; padding: 10px 6px; border: none; background: none; cursor: pointer; border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--text-light); transition: all .2s; font-family: inherit; }
    .tab-btn.active { background: var(--primary); color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .card { background: var(--card); border-radius: var(--radius); padding: 18px; margin-bottom: 12px; box-shadow: var(--shadow); }
    .card-title { font-size: 15px; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; justify-content: space-between; }

    .members-wrap { display: flex; flex-wrap: wrap; gap: 8px; }
    .member-chip { display: inline-flex; align-items: center; gap: 6px; background: var(--bg); border-radius: 20px; padding: 5px 12px 5px 6px; font-size: 13px; font-weight: 500; }
    .avatar { width: 26px; height: 26px; border-radius: 50%; background: var(--primary); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; flex-shrink: 0; }
    .me-tag { background: var(--primary); color: #fff; font-size: 10px; padding: 1px 5px; border-radius: 8px; font-weight: 700; }

    .avatar-picker-wrap { margin-top: 6px; }
    .avatar-picker-wrap label { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 7px; display: block; }
    .avatar-picker { display: flex; flex-wrap: wrap; gap: 6px; }
    .avatar-opt { width: 40px; height: 40px; border-radius: 10px; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid transparent; transition: all .15s; background: var(--bg); user-select: none; }
    .avatar-opt:hover { border-color: var(--primary-light); transform: scale(1.1); }
    .avatar-opt.selected { border-color: var(--primary); background: rgba(99,102,241,.1); box-shadow: 0 0 0 2px rgba(99,102,241,.18); transform: scale(1.08); }

    .add-member-row { display: flex; gap: 8px; margin-top: 12px; }

    .expense-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .expense-item:last-child { border-bottom: none; padding-bottom: 0; }
    .exp-icon { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .exp-info { flex: 1; min-width: 0; }
    .exp-desc { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
    .exp-meta { font-size: 12px; color: var(--text-light); }
    .exp-amount { font-size: 17px; font-weight: 800; color: var(--primary); white-space: nowrap; }

    .balance-item { display: flex; align-items: center; gap: 11px; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .balance-item:last-child { border-bottom: none; }
    .balance-name { flex: 1; font-weight: 600; font-size: 14px; }
    .balance-amount { font-size: 15px; font-weight: 800; }
    .pos { color: var(--success); }
    .neg { color: var(--danger); }
    .zero { color: var(--text-light); }

    .transfer-item { display: flex; align-items: center; gap: 10px; padding: 13px 14px; background: var(--bg); border-radius: 10px; margin-bottom: 8px; }
    .tr-from { font-weight: 700; color: var(--danger); font-size: 14px; }
    .tr-to   { font-weight: 700; color: var(--success); font-size: 14px; }
    .tr-arrow { font-size: 16px; color: var(--text-light); }
    .tr-amount { margin-right: auto; font-size: 17px; font-weight: 800; color: var(--primary); white-space: nowrap; }

    .add-form { background: var(--card); border-radius: var(--radius); padding: 18px; margin-bottom: 12px; box-shadow: var(--shadow); }
    .form-row { display: flex; gap: 10px; }
    .form-row .form-group { flex: 1; }

    .empty { text-align: center; padding: 36px 16px; color: var(--text-light); }
    .empty-icon { font-size: 44px; margin-bottom: 10px; }
    .empty h3 { font-size: 17px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
    .empty p { font-size: 13px; }

    .exp-amount { font-size: 17px; font-weight: 800; color: var(--primary); white-space: nowrap; text-align: start; }
    .exp-amount-orig { font-size: 11px; color: var(--text-light); font-weight: 600; display: block; }

    .log-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .log-item:last-child { border-bottom: none; }
    .log-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .log-icon.add-icon { background: rgba(16,185,129,.12); }
    .log-icon.del-icon { background: rgba(239,68,68,.12); }
    .log-info { flex: 1; min-width: 0; }
    .log-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .log-title-del { text-decoration: line-through; opacity: .6; }
    .log-meta-text { font-size: 12px; color: var(--text-light); }
    .log-warn { font-size: 11px; color: var(--danger); font-weight: 700; margin-top: 3px; }
    .log-amount { font-size: 14px; font-weight: 700; white-space: nowrap; }
    .log-amount-orig { font-size: 11px; color: var(--text-light); font-weight: 600; display: block; }

    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(80px); background: #1e293b; color: #fff; padding: 11px 22px; border-radius: 10px; font-size: 14px; font-weight: 600; transition: transform .3s; z-index: 999; white-space: nowrap; }
    .toast.show { transform: translateX(-50%) translateY(0); }

    .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin .7s linear infinite; margin: 40px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 480px) {
      .form-row { flex-direction: column; gap: 0; }
      .summary-row { grid-template-columns: 1fr 1fr; }
      .summary-row .summary-card:last-child { grid-column: 1 / -1; }
    }

    #my-groups-section { width: 100%; max-width: 400px; margin-top: 20px; }
    .my-groups-title { font-size: 13px; font-weight: 700; color: var(--text-light); margin-bottom: 10px; text-align: center; text-transform: uppercase; letter-spacing: .5px; }
    .saved-group-item { background: var(--card); border-radius: var(--radius); margin-bottom: 8px; box-shadow: var(--shadow); overflow: hidden; transition: box-shadow .15s; }
    .saved-group-item:hover { box-shadow: var(--shadow-md); }
    .sgi-header { display: flex; align-items: center; gap: 12px; padding: 13px 16px; cursor: pointer; user-select: none; }
    .saved-group-info { flex: 1; min-width: 0; }
    .saved-group-name { font-weight: 700; font-size: 15px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .saved-group-meta { font-size: 12px; color: var(--text-light); }
    .sgi-arrow { font-size: 13px; color: var(--text-light); transition: transform .25s; flex-shrink: 0; }
    .saved-group-item.expanded .sgi-arrow { transform: rotate(180deg); }
    .sgi-details { border-top: 1px solid var(--border); display: none; }
    .saved-group-item.expanded .sgi-details { display: block; }
    .sgi-detail-content { padding: 12px 16px 16px; }
    .sgi-stats { display: flex; gap: 6px; margin-bottom: 10px; }
    .sgi-stat { flex: 1; text-align: center; padding: 8px 4px; background: var(--bg); border-radius: 8px; }
    .sgi-stat-val { display: block; font-size: 18px; font-weight: 800; color: var(--primary); }
    .sgi-stat-lbl { font-size: 11px; color: var(--text-light); font-weight: 600; }
    .sgi-members { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
    .sgi-actions { display: flex; gap: 8px; }

    .invite-banner { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: #fff; border-radius: var(--radius); padding: 18px 20px; margin-bottom: 20px; text-align: center; }
    .invite-banner h2 { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
    .invite-banner p { font-size: 13px; opacity: .85; margin-bottom: 14px; }

    .home-actions { display: flex; gap: 10px; margin-bottom: 14px; }
    .home-action-btn { flex: 1; padding: 14px 10px; font-size: 15px; font-weight: 700; }
    @keyframes fadeSlideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    .home-card.opening { animation: fadeSlideDown .22s ease; }

    /* â”€â”€ Dark Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    [data-theme="dark"] {
      --bg:         #0f172a;
      --card:       #1e293b;
      --text:       #f1f5f9;
      --text-light: #94a3b8;
      --border:     #334155;
      --shadow:     0 1px 3px rgba(0,0,0,.4);
      --shadow-md:  0 4px 6px -1px rgba(0,0,0,.4);
    }
    [data-theme="dark"] input,
    [data-theme="dark"] select { background: #0f172a; color: var(--text); }
    [data-theme="dark"] input:focus,
    [data-theme="dark"] select:focus { background: #1e293b; }
    .dark-toggle { background: rgba(255,255,255,.15); border: none; color: #fff; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: background .15s; }
    .dark-toggle:hover { background: rgba(255,255,255,.28); }

    /* â”€â”€ Group name / emoji edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .g-name-wrap { display: flex; align-items: center; gap: 6px; }
    .g-name-edit-btn { background: rgba(255,255,255,.18); border: none; color: #fff; padding: 2px 7px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: inherit; }
    .g-name-edit-btn:hover { background: rgba(255,255,255,.32); }
    #g-name-input { background: rgba(255,255,255,.2); border: 1.5px solid rgba(255,255,255,.5); border-radius: 7px; color: #fff; padding: 3px 9px; font-size: 17px; font-weight: 800; width: 160px; font-family: inherit; }
    .group-emoji-btn { font-size: 26px; cursor: pointer; background: rgba(255,255,255,.12); border: none; border-radius: 10px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; transition: background .15s; flex-shrink: 0; }
    .group-emoji-btn:hover { background: rgba(255,255,255,.25); }
    .emoji-picker-popup { position: absolute; background: var(--card); border: 1.5px solid var(--border); border-radius: 12px; padding: 8px; box-shadow: var(--shadow-md); z-index: 300; display: flex; flex-wrap: wrap; gap: 4px; width: 220px; }
    .emoji-pick-opt { font-size: 22px; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 7px; transition: background .12s; }
    .emoji-pick-opt:hover { background: var(--bg); }

    /* â”€â”€ Close group â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .closed-banner { background: linear-gradient(135deg,#64748b,#475569); color: #fff; border-radius: var(--radius); padding: 13px 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; }

    /* â”€â”€ Unequal split â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .unequal-toggle-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer; user-select: none; }
    .unequal-toggle-row input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--primary); cursor: pointer; }
    .unequal-toggle-row span { font-size: 13px; font-weight: 600; color: var(--text-light); }
    .split-members-bar { background: var(--bg); border: 1.5px solid var(--border); border-radius: 10px; padding: 10px 12px; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 8px; animation: fadeSlideDown .18s ease; }
    .split-member-check { display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 500; cursor: pointer; padding: 4px 8px; border-radius: 20px; border: 1.5px solid var(--border); background: var(--card); transition: all .15s; }
    .split-member-check input { width: 14px; height: 14px; accent-color: var(--primary); cursor: pointer; }

    /* â”€â”€ Expense note + split tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .exp-note { font-size: 11px; color: var(--text-light); font-style: italic; margin-top: 1px; }
    .exp-split-tag { font-size: 10px; background: rgba(79,70,229,.1); color: var(--primary); border-radius: 5px; padding: 1px 5px; font-weight: 600; display: inline-block; margin-top: 2px; }

    /* â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-wrap { position: relative; margin-bottom: 12px; }
    .search-wrap input { padding-right: 34px; font-size: 14px; }
    .search-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-light); pointer-events: none; }

    /* â”€â”€ Edit modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 500; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal { background: var(--card); border-radius: var(--radius); padding: 22px; width: 100%; max-width: 400px; box-shadow: var(--shadow-md); animation: fadeSlideDown .2s ease; }
    .modal-title { font-size: 16px; font-weight: 700; margin-bottom: 14px; }
    .modal-actions { display: flex; gap: 8px; margin-top: 14px; }

    /* â”€â”€ Payment reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tr-copy { background: rgba(79,70,229,.1); border: none; color: var(--primary); padding: 5px 9px; border-radius: 7px; cursor: pointer; font-size: 12px; font-family: inherit; font-weight: 600; transition: background .15s; white-space: nowrap; flex-shrink: 0; }
    .tr-copy:hover { background: rgba(79,70,229,.2); }

    /* â”€â”€ Per-member paid summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .member-paid-section { margin-top: 18px; padding-top: 14px; border-top: 1px solid var(--border); }
    .member-paid-title { font-size: 12px; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 10px; }
    .member-paid-row { display: flex; align-items: center; gap: 9px; padding: 6px 0; border-bottom: 1px solid var(--border); }
    .member-paid-row:last-child { border-bottom: none; }
    .member-paid-name { flex: 1; font-size: 13px; font-weight: 600; }
    .member-paid-amt { font-size: 13px; color: var(--text-light); font-weight: 600; }

    /* â”€â”€ Reactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .reactions-row { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
    .reaction-btn { background: var(--bg); border: 1.5px solid var(--border); border-radius: 20px; padding: 2px 8px; font-size: 13px; cursor: pointer; transition: all .15s; display: flex; align-items: center; gap: 3px; font-family: inherit; }
    .reaction-btn:hover { border-color: var(--primary-light); }
    .reaction-btn.mine { border-color: var(--primary); background: rgba(79,70,229,.08); }
    .reaction-count { font-size: 11px; font-weight: 700; color: var(--text-light); }
    .reaction-btn.mine .reaction-count { color: var(--primary); }
    .reaction-add { background: none; border: 1.5px dashed var(--border); border-radius: 20px; padding: 2px 8px; font-size: 13px; cursor: pointer; color: var(--text-light); transition: all .15s; font-family: inherit; }
    .reaction-add:hover { border-color: var(--primary); color: var(--primary); }

    /* â”€â”€ Custom split amount inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .split-member-row { display: flex; align-items: center; gap: 8px; width: 100%; padding: 3px 0; }
    .split-member-name { flex: 1; font-size: 13px; font-weight: 600; }
    .split-amount-input { width: 90px !important; padding: 6px 8px !important; font-size: 13px !important; text-align: left; }
    .split-remaining-row { width: 100%; display: flex; align-items: center; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; gap: 8px; }
    .split-remaining-ok  { color: var(--success); font-weight: 700; }
    .split-remaining-err { color: var(--danger);  font-weight: 700; }

    /* â”€â”€ Payment item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .expense-item.payment-item { background: rgba(16,185,129,.05); border-radius: 8px; padding: 8px 10px; }
    .payment-item .exp-amount  { color: var(--success) !important; }
  </style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- Edit expense modal -->
<div id="edit-modal" class="modal-overlay" style="display:none" onclick="closeEditModal(event)">
  <div class="modal">
    <div class="modal-title">âœï¸ ×¢×¨×™×›×ª ×”×•×¦××”</div>
    <input type="hidden" id="edit-exp-id">
    <div class="form-group">
      <label>×ª×™××•×¨</label>
      <input id="edit-desc" type="text" maxlength="60">
    </div>
    <div class="form-group">
      <label>×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™)</label>
      <input id="edit-note" type="text" maxlength="80" placeholder="×”×¢×¨×” ×§×¦×¨×”...">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>×¡×›×•×</label>
        <input id="edit-amount" type="number" min="0.01" step="0.01">
      </div>
      <div class="form-group" style="max-width:100px">
        <label>××˜×‘×¢</label>
        <select id="edit-currency">
          <option value="ILS">â‚ª ×©×§×œ</option>
          <option value="USD">$ ×“×•×œ×¨</option>
          <option value="EUR">â‚¬ ×™×•×¨×•</option>
          <option value="GBP">Â£ ×¤××•× ×“</option>
          <option value="JPY">Â¥ ×™×Ÿ</option>
          <option value="JOD">JD ×“×™× ×¨</option>
          <option value="HUF">Ft ×¤×•×¨×™× ×˜</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1" onclick="saveEditExpense()">×©××•×¨</button>
      <button class="btn btn-secondary" onclick="closeEditModal()">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<div id="home-screen" class="screen active">
  <div class="logo">ğŸ’¸</div>
  <h1 class="app-title">Splits</h1>
  <p class="app-subtitle">×—×œ×§×• ×”×•×¦××•×ª ×‘×§×œ×•×ª ×¢× ×—×‘×¨×™× ×•××©×¤×—×”</p>

  <div class="home-actions">
    <button class="btn btn-primary home-action-btn" onclick="toggleHomeForm('create')">âœ¨ ×§×‘×•×¦×” ×—×“×©×”</button>
    <button class="btn btn-secondary home-action-btn" onclick="toggleHomeForm('join')">ğŸš€ ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×”</button>
  </div>

  <div id="create-form-card" class="home-card" style="display:none">
    <div class="form-group">
      <label>×©× ×”×§×‘×•×¦×”</label>
      <input id="c-group" type="text" placeholder='×œ××©×œ: "×˜×™×•×œ ×œ××™×œ×ª"' maxlength="50">
    </div>
    <div class="form-group">
      <label>×”×©× ×©×œ×š</label>
      <input id="c-user" type="text" placeholder="×”×›× ×¡ ××ª ×©××š" maxlength="30">
    </div>
    <div class="form-group avatar-picker-wrap">
      <label>×”××•×•×˜××¨ ×©×œ×š</label>
      <div class="avatar-picker" id="ap-create"></div>
    </div>
    <button class="btn btn-primary" onclick="createGroup()">âœ¨ ×¦×•×¨ ×§×‘×•×¦×”</button>
  </div>

  <div id="join-form-card" class="home-card" style="display:none">
    <div class="form-group">
      <label>×§×•×“ ×§×‘×•×¦×”</label>
      <input id="j-code" type="text" placeholder="6 ×ª×•×•×™×, ×œ××©×œ: ABC123" maxlength="6"
             oninput="this.value=this.value.toUpperCase()">
    </div>
    <div class="form-group">
      <label>×”×©× ×©×œ×š</label>
      <input id="j-user" type="text" placeholder="×”×›× ×¡ ××ª ×©××š" maxlength="30">
    </div>
    <div class="form-group avatar-picker-wrap">
      <label>×”××•×•×˜××¨ ×©×œ×š</label>
      <div class="avatar-picker" id="ap-join"></div>
    </div>
    <button class="btn btn-primary" onclick="joinGroup()">ğŸš€ ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×”</button>
  </div>

  <div id="my-groups-section" style="display:none">
    <div class="my-groups-title">×”×§×‘×•×¦×•×ª ×©×œ×™</div>
    <div id="my-groups-list"></div>
  </div>
</div>

<div id="group-screen" class="screen">
  <div class="group-header" style="position:relative">
    <div style="display:flex;align-items:center;gap:10px">
      <button class="group-emoji-btn" id="g-emoji-btn" onclick="openGroupEmojiPicker()" title="×©× ×” ×××•×’'×™ ×§×‘×•×¦×”">ğŸ’¸</button>
      <div id="group-emoji-popup" class="emoji-picker-popup" style="display:none;top:70px;right:auto;left:14px"></div>
      <div>
        <div class="g-name-wrap">
          <h1 id="g-name" style="cursor:pointer" ondblclick="startEditGroupName()" title="×œ×—×¥ ×¤×¢××™×™× ×œ×¢×¨×™×›×”"></h1>
          <button class="g-name-edit-btn" onclick="startEditGroupName()">âœï¸</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:2px">
          <div class="code-badge" onclick="copyCode()" title="×œ×—×¥ ×œ×”×¢×ª×§×”">
            ğŸ“‹ <span id="g-code"></span>
          </div>
          <span id="s-members" style="font-size:12px;opacity:.7;font-weight:600">ğŸ‘¥ 0</span>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-direction:column;align-items:flex-end">
      <div style="display:flex;gap:6px">
        <button class="dark-toggle" id="dark-btn" onclick="toggleDark()" title="××¦×‘ ×œ×™×œ×”">ğŸŒ™</button>
        <button class="leave-btn" onclick="leaveGroup()">×™×¦×™××” â†</button>
      </div>
      <button class="leave-btn" onclick="shareGroupLink()" title="×©×œ×— ×§×™×©×•×¨ ×”×¦×˜×¨×¤×•×ª">ğŸ”— ×©×ª×£ ×§×™×©×•×¨</button>
      <button class="leave-btn" id="close-group-btn" onclick="toggleCloseGroup()" style="font-size:12px">ğŸ”’ ×¡×’×¨× ×• ×—×©×‘×•×Ÿ</button>
    </div>
  </div>

  <div class="summary-row">
    <div class="summary-card">
      <div class="summary-label">×¡×”×´×› ×”×•×¦××•×ª</div>
      <div class="summary-value" id="s-total">â‚ª0</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">×—×œ×§ ×œ××—×“</div>
      <div class="summary-value" id="s-share">â‚ª0</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">×”×××–×Ÿ ×©×œ×™</div>
      <div class="summary-value" id="s-mybal">â‚ª0</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('expenses')">×”×•×¦××•×ª</button>
    <button class="tab-btn"        onclick="switchTab('balances')">×™×ª×¨×•×ª</button>
    <button class="tab-btn"        onclick="switchTab('transfers')">×”×¢×‘×¨×•×ª</button>
    <button class="tab-btn"        onclick="switchTab('log')">ğŸ“‹ ×œ×•×’</button>
  </div>

  <div id="tab-expenses" class="tab-content active">
    <div id="closed-banner-el" class="closed-banner" style="display:none">
      <span class="cb-icon">ğŸ”’</span>
      <span>×”×§×‘×•×¦×” ×¡×’×•×¨×” â€” ××™×Ÿ ××¤×©×¨×•×ª ×œ×”×•×¡×™×£ ×”×•×¦××•×ª ×—×“×©×•×ª</span>
    </div>
    <div class="add-form" id="add-expense-form">
      <div class="card-title">×”×•×¡×£ ×”×•×¦××”</div>
      <div class="form-group">
        <label>×ª×™××•×¨</label>
        <input id="e-desc" type="text" placeholder='×œ××©×œ: "××¨×•×—×ª ×¢×¨×‘"' maxlength="60">
      </div>
      <div class="form-group">
        <label>×”×¢×¨×” <span style="font-weight:400;color:var(--text-light)">(××•×¤×¦×™×•× ×œ×™)</span></label>
        <input id="e-note" type="text" placeholder="×”×¢×¨×” ×§×¦×¨×”..." maxlength="80">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>×¡×›×•×</label>
          <input id="e-amount" type="number" placeholder="0.00" min="0.01" step="0.01">
        </div>
        <div class="form-group" style="max-width:100px">
          <label>××˜×‘×¢</label>
          <select id="e-currency">
            <option value="ILS">â‚ª ×©×§×œ</option>
            <option value="USD">$ ×“×•×œ×¨</option>
            <option value="EUR">â‚¬ ×™×•×¨×•</option>
            <option value="GBP">Â£ ×¤××•× ×“</option>
            <option value="JPY">Â¥ ×™×Ÿ</option>
            <option value="JOD">JD ×“×™× ×¨</option>
            <option value="HUF">Ft ×¤×•×¨×™× ×˜</option>
          </select>
        </div>
        <div class="form-group">
          <label>×©×™×œ×</label>
          <select id="e-paidby"></select>
        </div>
      </div>
      <label class="unequal-toggle-row">
        <input type="checkbox" id="e-unequal" onchange="toggleSplitMembers()">
        <span>×—×œ×•×§×” ×œ× ×©×•×•×” (×‘×—×¨ ××™ ××©×ª×ª×£)</span>
      </label>
      <div id="split-members-bar" class="split-members-bar" style="display:none"></div>
      <button class="btn btn-primary" onclick="addExpense()">+ ×”×•×¡×£ ×”×•×¦××”</button>
    </div>

    <div class="card">
      <div class="card-title">×—×‘×¨×™ ×”×§×‘×•×¦×”</div>
      <div class="members-wrap" id="members-list"></div>
    </div>

    <div class="card">
      <div class="card-title">×”×™×¡×˜×•×¨×™×™×ª ×”×•×¦××•×ª</div>
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input id="exp-search" type="text" placeholder="×—×™×¤×•×© ×”×•×¦××”..." oninput="renderExpenses()">
      </div>
      <div id="expenses-list"><div class="spinner"></div></div>
    </div>
  </div>

  <div id="tab-balances" class="tab-content">
    <div class="card">
      <div class="card-title">×™×ª×¨×•×ª × ×•×›×—×™×•×ª</div>
      <p style="font-size:12px;color:var(--text-light);margin-bottom:14px">
        ×¡×›×•× ×—×™×•×‘×™ = ×—×™×™×‘×™× ×œ×š | ×¡×›×•× ×©×œ×™×œ×™ = ××ª×” ×—×™×™×‘
      </p>
      <div id="balances-list"></div>
    </div>
  </div>

  <div id="tab-transfers" class="tab-content">
    <div class="card">
      <div class="card-title">×”×¢×‘×¨×•×ª × ×“×¨×©×•×ª</div>
      <p style="font-size:12px;color:var(--text-light);margin-bottom:14px">
        ×”××™× ×™××•× ×”×¢×‘×¨×•×ª ×œ××™×–×•×Ÿ ××œ× ×©×œ ×›×œ ×”×—×©×‘×•× ×•×ª
      </p>
      <div id="transfers-list"></div>
    </div>
  </div>

  <div id="tab-log" class="tab-content">
    <div class="card">
      <div class="card-title">×œ×•×’ ×¤×¢×•×œ×•×ª</div>
      <p style="font-size:12px;color:var(--text-light);margin-bottom:14px">
        ×”×™×¡×˜×•×¨×™×” ×©×œ ×”×•×¡×¤×•×ª ×•××—×™×§×•×ª ×”×•×¦××•×ª
      </p>
      <div id="log-list"></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp }    from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
import { getDatabase, ref, set, get, push, update, remove, onValue }
                             from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

const app = initializeApp({
  apiKey:      "AIzaSyA5psJbM4VDL5Dq3Dd3k1qoojepxtlg7OU",
  authDomain:  "coffe-a2619.firebaseapp.com",
  databaseURL: "https://coffe-a2619-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:   "coffe-a2619",
  storageBucket: "coffe-a2619.firebasestorage.app",
});
const db = getDatabase(app);

const AVATARS = ['ğŸ˜€','ğŸ˜','ğŸ¦Š','ğŸ»','ğŸ¦','ğŸ¼','ğŸ¦‹','ğŸŒŸ','ğŸ¯','ğŸš€','ğŸ¸','ğŸ„','ğŸŒˆ','ğŸ¦„','ğŸ¯','ğŸ™'];
const AVATAR_COLORS = [
  '#6366f1','#f59e0b','#10b981','#e11d48',
  '#8b5cf6','#0891b2','#f97316','#db2777',
  '#14b8a6','#65a30d','#9333ea','#ea580c',
];
const GROUP_GRADIENTS = [
  ['#6366f1','#8b5cf6'],
  ['#0ea5e9','#6366f1'],
  ['#10b981','#0ea5e9'],
  ['#f59e0b','#ef4444'],
  ['#ec4899','#8b5cf6'],
  ['#14b8a6','#6366f1'],
  ['#f97316','#ec4899'],
  ['#84cc16','#14b8a6'],
];

let selectedAvatarCreate = AVATARS[0];
let selectedAvatarJoin   = AVATARS[0];

function strHash(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) | 0;
  return Math.abs(h);
}
function avatarColor(id) {
  return AVATAR_COLORS[strHash(id) % AVATAR_COLORS.length];
}
function groupGradient(code) {
  const g = GROUP_GRADIENTS[strHash(code) % GROUP_GRADIENTS.length];
  return `linear-gradient(135deg, ${g[0]} 0%, ${g[1]} 100%)`;
}
function renderAvatarPicker(containerId, form) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const current = form === 'create' ? selectedAvatarCreate : selectedAvatarJoin;
  container.innerHTML = AVATARS.map(a =>
    `<div class="avatar-opt${a === current ? ' selected' : ''}" onclick="pickAvatar('${form}','${a}')">${a}</div>`
  ).join('');
}
window.pickAvatar = function(form, emoji) {
  if (form === 'create') selectedAvatarCreate = emoji;
  else selectedAvatarJoin = emoji;
  renderAvatarPicker(form === 'create' ? 'ap-create' : 'ap-join', form);
};

let groupCode   = null;
let myId        = null;
let myName      = null;
let groupData   = { name:'', members:{}, expenses:{}, log:{} };
let unsubscribe = null;

// â”€â”€â”€ Exchange rates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let exchangeRates = null;
let ratesFetchedAt = 0;
async function fetchRates() {
  if (exchangeRates && Date.now() - ratesFetchedAt < 3600000) return;
  try {
    const r = await fetch('https://open.er-api.com/v6/latest/ILS');
    if (!r.ok) throw new Error();
    const data = await r.json();
    if (data.result === 'success') { exchangeRates = data.rates; ratesFetchedAt = Date.now(); }
    else throw new Error();
  } catch {
    // fallback approximate rates (1 ILS = X foreign)
    exchangeRates = { ILS:1, USD:0.273, EUR:0.252, GBP:0.215, JPY:41.5, JOD:0.194, HUF:100.5 };
  }
}
function toILS(amount, currency) {
  if (!currency || currency === 'ILS') return amount;
  const rate = exchangeRates?.[currency];
  return (rate && rate !== 0) ? +(amount / rate).toFixed(4) : amount;
}
const CURR_SYMBOLS = { ILS:'â‚ª', USD:'$', EUR:'â‚¬', GBP:'Â£', JPY:'Â¥', JOD:'JD', HUF:'Ft' };
function currSymbol(c) { return CURR_SYMBOLS[c] || c; }

function myUserId() {
  let id = localStorage.getItem('splits_uid');
  if (!id) {
    id = 'u_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7);
    localStorage.setItem('splits_uid', id);
  }
  return id;
}

function genCode() {
  const abc = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:6}, () => abc[Math.random()*abc.length|0]).join('');
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2800);
}

function initials(name) {
  return name.trim().split(/\s+/).map(w=>w[0]).join('').toUpperCase().slice(0,2);
}

window.toggleHomeForm = function(which) {
  const createCard = document.getElementById('create-form-card');
  const joinCard   = document.getElementById('join-form-card');
  const target = which === 'create' ? createCard : joinCard;
  const other  = which === 'create' ? joinCard   : createCard;
  const isOpen = target.style.display !== 'none';
  other.style.display = 'none';
  if (isOpen) {
    target.style.display = 'none';
  } else {
    target.style.display = 'block';
    target.classList.add('opening');
    setTimeout(() => target.classList.remove('opening'), 250);
  }
};

window.createGroup = async function() {
  const gName = document.getElementById('c-group').value.trim();
  const uName = document.getElementById('c-user').value.trim();
  if (!gName) { toast('×× × ×”×›× ×¡ ×©× ×§×‘×•×¦×”'); return; }
  if (!uName) { toast('×× × ×”×›× ×¡ ××ª ×©××š');   return; }

  const uid = myUserId();
  let code;
  for (let i=0; i<5; i++) {
    code = genCode();
    if (!(await get(ref(db,`splits/${code}`))).exists()) break;
  }

  await set(ref(db,`splits/${code}`), {
    name: gName,
    createdAt: Date.now(),
    members: { [uid]: { name: uName, joinedAt: Date.now(), avatar: selectedAvatarCreate } }
  });

  saveGroupToList(code, uid, uName, gName);
  enterGroup(code, uid, uName);
};

window.joinGroup = async function() {
  const code  = document.getElementById('j-code').value.trim().toUpperCase();
  const uName = document.getElementById('j-user').value.trim();
  if (code.length !== 6) { toast('×§×•×“ ×—×™×™×‘ ×œ×”×™×•×ª 6 ×ª×•×•×™×'); return; }
  if (!uName)            { toast('×× × ×”×›× ×¡ ××ª ×©××š');        return; }

  try {
    const snap = await get(ref(db,`splits/${code}`));
    if (!snap.exists()) { toast('×§×‘×•×¦×” ×œ× × ××¦××” â€“ ×‘×“×•×§ ××ª ×”×§×•×“'); return; }

    const groupName = snap.val().name || code;
    const uid = myUserId();
    await update(ref(db,`splits/${code}/members/${uid}`), { name: uName, joinedAt: Date.now(), avatar: selectedAvatarJoin });

    saveGroupToList(code, uid, uName, groupName);
    enterGroup(code, uid, uName);
  } catch (err) {
    console.error('joinGroup error:', err);
    toast('×©×’×™××” ×‘×”×¦×˜×¨×¤×•×ª ×œ×§×‘×•×¦×” â€“ × ×¡×” ×©×•×‘');
  }
};

function getSavedGroups() {
  try { return JSON.parse(localStorage.getItem('splits_groups') || '[]'); }
  catch { return []; }
}

function saveGroupToList(code, uid, myName, groupName) {
  const groups = getSavedGroups().filter(g => g.code !== code);
  groups.unshift({ code, uid, myName, groupName, lastAccessed: Date.now() });
  localStorage.setItem('splits_groups', JSON.stringify(groups.slice(0, 20)));
}

let expandedGroupIdx = null;

function renderMyGroups() {
  const groups = getSavedGroups();
  const section = document.getElementById('my-groups-section');
  const list = document.getElementById('my-groups-list');
  if (!groups.length) { section.style.display = 'none'; expandedGroupIdx = null; return; }
  section.style.display = '';
  list.innerHTML = groups.map((g, i) => `
    <div class="saved-group-item ${expandedGroupIdx === i ? 'expanded' : ''}" id="sgi-${i}">
      <div class="sgi-header" onclick="toggleGroupDetails(${i})">
        <div class="avatar" style="width:38px;height:38px;font-size:14px;flex-shrink:0;background:${groupGradient(g.code)}">${initials(g.groupName||g.code)}</div>
        <div class="saved-group-info">
          <div class="saved-group-name">${g.groupName || g.code}</div>
          <div class="saved-group-meta">×”×©×ª×ª×¤×ª ×›: ${g.myName} &nbsp;Â·&nbsp; ×§×•×“: ${g.code}</div>
        </div>
        <span class="sgi-arrow">â–¼</span>
        <button class="btn btn-secondary btn-sm" onclick="leaveGroupForReal('${g.code}','${g.uid}',${i},event)" title="×¦× ××”×§×‘×•×¦×”" style="flex-shrink:0;color:var(--danger)">ğŸ—‘</button>
      </div>
      <div class="sgi-details" id="sgd-${i}">
        <div class="sgi-detail-content">
          <div class="spinner" style="width:22px;height:22px;margin:10px auto;border-width:2px"></div>
        </div>
      </div>
    </div>
  `).join('');
  if (expandedGroupIdx !== null) loadGroupDetails(expandedGroupIdx);
}

window.toggleGroupDetails = function(idx) {
  expandedGroupIdx = (expandedGroupIdx === idx) ? null : idx;
  renderMyGroups();
};

async function loadGroupDetails(idx) {
  const groups = getSavedGroups();
  const g = groups[idx];
  if (!g) return;
  const detailEl = document.getElementById(`sgd-${idx}`);
  if (!detailEl) return;
  try {
    const snap = await get(ref(db, `splits/${g.code}`));
    if (!snap.exists()) {
      detailEl.innerHTML = '<div class="sgi-detail-content" style="color:var(--danger);font-size:13px">×§×‘×•×¦×” ×œ× × ××¦××” â€“ ×™×™×ª×›×Ÿ ×©× ××—×§×”</div>';
      return;
    }
    const data = snap.val();
    const members  = data.members  || {};
    const expenses = data.expenses || {};
    const mIds  = Object.keys(members);
    const total = Object.values(expenses).reduce((s,e) => s+(e.amountILS ?? e.amount ?? 0), 0);
    g.groupName = data.name || g.groupName;
    localStorage.setItem('splits_groups', JSON.stringify(groups));
    detailEl.innerHTML = `
      <div class="sgi-detail-content">
        <div class="sgi-stats">
          <div class="sgi-stat"><span class="sgi-stat-val">${mIds.length}</span><span class="sgi-stat-lbl">×—×‘×¨×™×</span></div>
          <div class="sgi-stat"><span class="sgi-stat-val">â‚ª${total.toFixed(0)}</span><span class="sgi-stat-lbl">×”×•×¦××•×ª</span></div>
          <div class="sgi-stat"><span class="sgi-stat-val">${Object.keys(expenses).length}</span><span class="sgi-stat-lbl">×¤×¢×•×œ×•×ª</span></div>
        </div>
        <div class="sgi-members">
          ${mIds.map(id=>`<div class="member-chip" style="font-size:12px;padding:3px 9px 3px 4px"><div class="avatar" style="width:22px;height:22px;font-size:${members[id].avatar?'13px':'10px'};background:${avatarColor(id)}">${members[id].avatar||initials(members[id].name)}</div>${members[id].name}</div>`).join('')}
        </div>
        <div class="sgi-actions">
          <button class="btn btn-primary" style="flex:1" onclick="enterSavedGroup(${idx})">×¤×ª×— ×§×‘×•×¦×” â†</button>
          <button class="btn btn-secondary" onclick="shareGroupLink('${g.code}')" title="×©×ª×£ ×§×™×©×•×¨ ×”×¦×˜×¨×¤×•×ª">ğŸ”— ×©×ª×£</button>
        </div>
      </div>`;
  } catch {
    detailEl.innerHTML = '<div class="sgi-detail-content" style="color:var(--danger);font-size:13px">×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™×</div>';
  }
}

window.enterSavedGroup = async function(idx) {
  const groups = getSavedGroups();
  const g = groups[idx];
  if (!g) return;
  const snap = await get(ref(db, `splits/${g.code}`));
  if (!snap.exists()) {
    toast('×§×‘×•×¦×” ×œ× × ××¦××” â€“ ×™×™×ª×›×Ÿ ×©× ××—×§×”');
    groups.splice(idx, 1);
    localStorage.setItem('splits_groups', JSON.stringify(groups));
    expandedGroupIdx = null;
    renderMyGroups();
    return;
  }
  g.groupName = snap.val().name || g.groupName;
  g.lastAccessed = Date.now();
  localStorage.setItem('splits_groups', JSON.stringify(groups));
  expandedGroupIdx = null;
  enterGroup(g.code, g.uid, g.myName);
};

window.removeGroupFromList = function(idx, e) {
  if (e && e.stopPropagation) e.stopPropagation();
  const groups = getSavedGroups();
  groups.splice(idx, 1);
  localStorage.setItem('splits_groups', JSON.stringify(groups));
  if (expandedGroupIdx === idx) expandedGroupIdx = null;
  else if (expandedGroupIdx > idx) expandedGroupIdx--;
  renderMyGroups();
};

window.leaveGroupForReal = async function(code, uid, idx, e) {
  if (e && e.stopPropagation) e.stopPropagation();

  // Remove this user from Firebase members
  await remove(ref(db, `splits/${code}/members/${uid}`));

  // If no members left â†’ delete the entire group
  const membersSnap = await get(ref(db, `splits/${code}/members`));
  if (!membersSnap.exists() || Object.keys(membersSnap.val() || {}).length === 0) {
    await remove(ref(db, `splits/${code}`));
  }

  // Remove from local list
  const groups = getSavedGroups();
  groups.splice(idx, 1);
  localStorage.setItem('splits_groups', JSON.stringify(groups));
  if (expandedGroupIdx === idx) expandedGroupIdx = null;
  else if (expandedGroupIdx > idx) expandedGroupIdx--;
  renderMyGroups();
  toast('×™×¦××ª ××”×§×‘×•×¦×”');
};

window.shareGroupLink = function(code) {
  const c = code || groupCode;
  if (!c) return;
  const url = location.origin + location.pathname + '?code=' + c;
  navigator.clipboard.writeText(url)
    .then(() => toast('×§×™×©×•×¨ ×”×•×¢×ª×§! ×©×œ×— ××•×ª×• ×œ×—×‘×¨×™×'))
    .catch(() => toast('×§×™×©×•×¨: ' + url));
};

function enterGroup(code, uid, name) {
  groupCode = code; myId = uid; myName = name;

  document.getElementById('home-screen').classList.remove('active');
  document.getElementById('group-screen').classList.add('active');
  document.querySelector('.group-header').style.background = groupGradient(code);
  initDark();

  if (unsubscribe) unsubscribe();
  unsubscribe = onValue(ref(db,`splits/${code}`), snap => {
    groupData = snap.val() || {};
    if (!groupData.members)  groupData.members  = {};
    if (!groupData.expenses) groupData.expenses = {};
    if (!groupData.log)      groupData.log      = {};
    render();
  });
}

// â”€â”€ Dark mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initDark() {
  const dark = localStorage.getItem('splits_dark') === '1';
  document.documentElement.setAttribute('data-theme', dark ? 'dark' : '');
  document.getElementById('dark-btn').textContent = dark ? 'â˜€ï¸' : 'ğŸŒ™';
}
window.toggleDark = function() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  document.documentElement.setAttribute('data-theme', isDark ? '' : 'dark');
  localStorage.setItem('splits_dark', isDark ? '0' : '1');
  document.getElementById('dark-btn').textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
};

// â”€â”€ Group emoji picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GROUP_EMOJIS = ['ğŸ’¸','âœˆï¸','ğŸ–ï¸','ğŸ•','ğŸ»','ğŸ‰','ğŸ ','ğŸš—','ğŸ›’','ğŸ¸','âš½','ğŸ¯','ğŸ•ï¸','ğŸ­','ğŸ’Š','ğŸ¾'];
window.openGroupEmojiPicker = function() {
  const pop = document.getElementById('group-emoji-popup');
  if (pop.style.display !== 'none') { pop.style.display = 'none'; return; }
  pop.innerHTML = GROUP_EMOJIS.map(e =>
    `<div class="emoji-pick-opt" onclick="setGroupEmoji('${e}')">${e}</div>`
  ).join('');
  pop.style.display = 'flex';
  setTimeout(() => document.addEventListener('click', closeEmojiPicker, {once:true}), 10);
};
function closeEmojiPicker(e) {
  const pop = document.getElementById('group-emoji-popup');
  if (pop && !pop.contains(e.target)) pop.style.display = 'none';
}
window.setGroupEmoji = async function(emoji) {
  document.getElementById('group-emoji-popup').style.display = 'none';
  document.getElementById('g-emoji-btn').textContent = emoji;
  await update(ref(db,`splits/${groupCode}`), { emoji });
};

// â”€â”€ Editable group name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.startEditGroupName = function() {
  const h1 = document.getElementById('g-name');
  const current = h1.textContent;
  h1.style.display = 'none';
  const inp = document.createElement('input');
  inp.id = 'g-name-input'; inp.value = current; inp.maxLength = 50;
  h1.parentNode.insertBefore(inp, h1);
  inp.focus(); inp.select();
  const save = async () => {
    const val = inp.value.trim();
    if (val && val !== current) {
      await update(ref(db,`splits/${groupCode}`), { name: val });
      saveGroupToList(groupCode, myId, myName, val);
    }
    inp.remove(); h1.style.display = '';
  };
  inp.addEventListener('blur', save);
  inp.addEventListener('keydown', e => { if (e.key === 'Enter') inp.blur(); if (e.key === 'Escape') { inp.value = current; inp.blur(); } });
};

// â”€â”€ Close / reopen group â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.toggleCloseGroup = async function() {
  const isClosed = !!groupData.closed;
  if (!isClosed) {
    if (!confirm('×œ×¡×’×•×¨ ××ª ×”×§×‘×•×¦×”? ×œ× × ×™×ª×Ÿ ×™×”×™×” ×œ×”×•×¡×™×£ ×”×•×¦××•×ª ×—×“×©×•×ª (××¤×©×¨ ×œ×¤×ª×•×— ××—×“×©)')) return;
  }
  await update(ref(db,`splits/${groupCode}`), { closed: !isClosed });
};

// â”€â”€ Custom split amounts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.toggleSplitMembers = function() {
  const on  = document.getElementById('e-unequal').checked;
  const bar = document.getElementById('split-members-bar');
  bar.style.display = on ? 'flex' : 'none';
  if (on) { renderSplitMembersBar(); autoFillEqual(); }
};
function renderSplitMembersBar() {
  const bar     = document.getElementById('split-members-bar');
  const members = groupData.members || {};
  bar.innerHTML =
    Object.entries(members).map(([id, m]) =>
      `<div class="split-member-row">
        <div class="avatar" style="background:${avatarColor(id)};font-size:${m.avatar?'13px':'10px'};width:24px;height:24px;flex-shrink:0">${m.avatar||initials(m.name)}</div>
        <span class="split-member-name">${m.name}</span>
        <input type="number" class="split-amount-input" id="split-amt-${id}"
               placeholder="0.00" step="0.01" min="0"
               oninput="updateSplitRemaining()">
      </div>`
    ).join('')
    + `<div class="split-remaining-row">
         <span id="split-remaining" class="split-remaining-err">×”×›× ×¡ ×¡×›×•××™×</span>
         <button type="button" class="btn-ghost" style="font-size:12px;padding:4px 8px" onclick="autoFillEqual()">âš¡ ×—×œ×§ ×©×•×•×”</button>
       </div>`;
}
window.autoFillEqual = function() {
  const members = groupData.members || {};
  const mIds    = Object.keys(members);
  if (!mIds.length) return;
  const rawAmt  = parseFloat(document.getElementById('e-amount').value) || 0;
  const currency = document.getElementById('e-currency').value || 'ILS';
  // use live rates if available, else approximate
  const totalILS = toILS(rawAmt, currency);
  const share    = +(totalILS / mIds.length).toFixed(2);
  mIds.forEach((id, i) => {
    const inp = document.getElementById(`split-amt-${id}`);
    if (!inp) return;
    // last person gets the remainder to avoid rounding errors
    inp.value = (i === mIds.length - 1)
      ? (totalILS - share * (mIds.length - 1)).toFixed(2)
      : share.toFixed(2);
  });
  updateSplitRemaining();
};
window.updateSplitRemaining = function() {
  const members  = groupData.members || {};
  let allocated  = 0;
  Object.keys(members).forEach(id => {
    const inp = document.getElementById(`split-amt-${id}`);
    if (inp) allocated += parseFloat(inp.value) || 0;
  });
  const rawAmt   = parseFloat(document.getElementById('e-amount').value) || 0;
  const currency = document.getElementById('e-currency').value || 'ILS';
  const totalILS = toILS(rawAmt, currency);
  const diff     = totalILS - allocated;
  const el       = document.getElementById('split-remaining');
  if (!el) return;
  el.textContent  = Math.abs(diff) < 0.02
    ? `âœ“ ××•×§×¦×” â‚ª${allocated.toFixed(2)}`
    : `××•×§×¦×” â‚ª${allocated.toFixed(2)} ××ª×•×š â‚ª${totalILS.toFixed(2)} (${diff > 0 ? '×—×¡×¨' : '×¢×•×“×£'} â‚ª${Math.abs(diff).toFixed(2)})`;
  el.className = Math.abs(diff) < 0.02 ? 'split-remaining-ok' : 'split-remaining-err';
};
function getSplitData() {
  if (!document.getElementById('e-unequal').checked) return null;
  const members = groupData.members || {};
  const result  = {};
  Object.keys(members).forEach(id => {
    const inp = document.getElementById(`split-amt-${id}`);
    const val = parseFloat(inp?.value);
    if (val > 0) result[id] = val;
  });
  return Object.keys(result).length ? result : null;
}

// â”€â”€ Debt repayment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.recordPayment = async function(fromId, toId, suggestedAmt) {
  const fromName = groupData.members[fromId]?.name || '?';
  const toName   = groupData.members[toId]?.name   || '?';
  const input    = prompt(`${fromName} ×©×™×œ× ×œ${toName} â€” ×›××”? (â‚ª)`, suggestedAmt);
  if (input === null) return;
  const amt = parseFloat(input);
  if (!amt || amt <= 0) { toast('×¡×›×•× ×œ× ×ª×§×™×Ÿ'); return; }
  const expRef = push(ref(db, `splits/${groupCode}/expenses`));
  await set(expRef, {
    type: 'payment',
    description: `ğŸ’¸ ${fromName} â†’ ${toName}`,
    amount: amt, currency: 'ILS', amountILS: amt,
    paidBy: fromId, paidTo: toId,
    payerName: fromName, recipientName: toName,
    timestamp: Date.now()
  });
  await push(ref(db, `splits/${groupCode}/log`), {
    type: 'payment',
    description: `ğŸ’¸ ${fromName} â†’ ${toName}`,
    amount: amt, currency: 'ILS', amountILS: amt,
    payerName: fromName, actor: myName, timestamp: Date.now()
  });
  toast(`âœ“ × ×¨×©×: ${fromName} ×©×™×œ× â‚ª${amt.toFixed(2)} ×œ${toName}`);
};

window.leaveGroup = function() {
  if (unsubscribe) { unsubscribe(); unsubscribe = null; }
  groupCode = myId = myName = null;
  document.getElementById('group-screen').classList.remove('active');
  document.getElementById('home-screen').classList.add('active');
  renderMyGroups();
};

window.copyCode = function() {
  navigator.clipboard.writeText(groupCode)
    .then(() => toast('×§×•×“ ×”×•×¢×ª×§: ' + groupCode))
    .catch(() => toast('×§×•×“: ' + groupCode));
};

window.switchTab = function(tab) {
  const order = ['expenses','balances','transfers','log'];
  document.querySelectorAll('.tab-btn').forEach((b,i) =>
    b.classList.toggle('active', order[i]===tab));
  document.querySelectorAll('.tab-content').forEach(tc =>
    tc.classList.toggle('active', tc.id === 'tab-'+tab));
};

window.addExpense = async function() {
  if (groupData.closed) { toast('×”×§×‘×•×¦×” ×¡×’×•×¨×” â€” ×œ× × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×”×•×¦××•×ª'); return; }
  const desc     = document.getElementById('e-desc').value.trim();
  const note     = document.getElementById('e-note').value.trim();
  const amount   = parseFloat(document.getElementById('e-amount').value);
  const currency = document.getElementById('e-currency').value || 'ILS';
  const paidBy   = document.getElementById('e-paidby').value;

  if (!desc)            { toast('×× × ×”×›× ×¡ ×ª×™××•×¨');    return; }
  if (!amount || amount<=0) { toast('×× × ×”×›× ×¡ ×¡×›×•× ×ª×§×™×Ÿ'); return; }

  await fetchRates();
  const amountILS = toILS(amount, currency);
  const member    = groupData.members[paidBy];
  const payerName = member?.name || '×œ× ×™×“×•×¢';

  const splitData = getSplitData();
  if (splitData !== null) {
    const splitTotal = Object.values(splitData).reduce((s,v) => s+v, 0);
    if (Math.abs(splitTotal - amountILS) > 0.10) {
      toast(`×¡×›×•× ×”×—×œ×•×§×” â‚ª${splitTotal.toFixed(2)} â‰  ×¡×”"×› â‚ª${amountILS.toFixed(2)}`);
      return;
    }
  }

  const expData = { description: desc, amount, currency, amountILS, paidBy, payerName, timestamp: Date.now() };
  if (note) expData.note = note;
  if (splitData !== null) expData.splitAmong = splitData;

  const expRef = push(ref(db,`splits/${groupCode}/expenses`));
  await set(expRef, expData);
  await push(ref(db,`splits/${groupCode}/log`), {
    type: 'add', expId: expRef.key,
    description: desc, amount, currency, amountILS, payerName,
    actor: myName, timestamp: Date.now()
  });

  document.getElementById('e-desc').value   = '';
  document.getElementById('e-amount').value = '';
  document.getElementById('e-note').value   = '';
  document.getElementById('e-unequal').checked = false;
  document.getElementById('split-members-bar').style.display = 'none';
  toast('×”×•×¦××” × ×•×¡×¤×” âœ“');
};

window.editExpense = function(expId) {
  const e = groupData.expenses[expId];
  if (!e) return;
  document.getElementById('edit-exp-id').value   = expId;
  document.getElementById('edit-desc').value     = e.description || '';
  document.getElementById('edit-note').value     = e.note || '';
  document.getElementById('edit-amount').value   = e.amount || '';
  document.getElementById('edit-currency').value = e.currency || 'ILS';
  document.getElementById('edit-modal').style.display = 'flex';
};

window.closeEditModal = function(e) {
  if (e && e.target !== document.getElementById('edit-modal')) return;
  document.getElementById('edit-modal').style.display = 'none';
};

window.saveEditExpense = async function() {
  const expId    = document.getElementById('edit-exp-id').value;
  const desc     = document.getElementById('edit-desc').value.trim();
  const note     = document.getElementById('edit-note').value.trim();
  const amount   = parseFloat(document.getElementById('edit-amount').value);
  const currency = document.getElementById('edit-currency').value || 'ILS';
  if (!desc)           { toast('×× × ×”×›× ×¡ ×ª×™××•×¨'); return; }
  if (!amount || amount<=0) { toast('×× × ×”×›× ×¡ ×¡×›×•× ×ª×§×™×Ÿ'); return; }
  await fetchRates();
  const amountILS = toILS(amount, currency);
  const upd = { description: desc, amount, currency, amountILS };
  if (note) upd.note = note; else upd.note = null;
  await update(ref(db,`splits/${groupCode}/expenses/${expId}`), upd);
  document.getElementById('edit-modal').style.display = 'none';
  toast('×”×•×¦××” ×¢×•×“×›× ×” âœ“');
};

window.copyReminder = function(fromName, toName, amount) {
  const groupName = groupData.name || groupCode;
  const text = `×”×™×™ ${fromName}! ×ª×¢×‘×™×¨ ×œ×™ â‚ª${amount} (×§×‘×•×¦×”: ${groupName}) ğŸ™`;
  navigator.clipboard.writeText(text)
    .then(() => toast('×˜×§×¡×˜ ×”×•×¢×ª×§! âœ“'))
    .catch(() => toast(text));
};

const REACTION_EMOJIS = ['ğŸ‘','â¤ï¸','ğŸ˜‚','ğŸ˜®','ğŸ”¥'];
window.toggleReaction = async function(expId, emoji) {
  const path = `splits/${groupCode}/expenses/${expId}/reactions/${myId}`;
  const current = groupData.expenses?.[expId]?.reactions?.[myId];
  if (current === emoji) {
    await remove(ref(db, path));
  } else {
    await set(ref(db, path), emoji);
  }
};

window.deleteExpense = async function(expId) {
  const exp = groupData.expenses[expId];
  if (exp) {
    await push(ref(db,`splits/${groupCode}/log`), {
      type: 'delete', expId,
      description: exp.description, amount: exp.amount,
      currency: exp.currency || 'ILS', amountILS: exp.amountILS ?? exp.amount,
      payerName: exp.payerName, actor: myName, timestamp: Date.now()
    });
  }
  await remove(ref(db,`splits/${groupCode}/expenses/${expId}`));
  toast('×”×•×¦××” × ××—×§×”');
};


function calcBalances() {
  const members  = groupData.members;
  const expenses = Object.values(groupData.expenses || {});
  const ids      = Object.keys(members);
  if (!ids.length) return {};

  const bal = {};
  ids.forEach(id => bal[id] = 0);

  expenses.forEach(e => {
    const amt = e.amountILS ?? e.amount ?? 0;

    // â”€â”€ Direct payment (debt repayment) â”€â”€
    if (e.type === 'payment') {
      if (e.paidBy in bal) bal[e.paidBy] += amt;
      if (e.paidTo in bal) bal[e.paidTo] -= amt;
      return;
    }

    const sa = e.splitAmong;
    if (sa && !Array.isArray(sa) && typeof sa === 'object') {
      // â”€â”€ Custom amounts per person â”€â”€
      Object.entries(sa).forEach(([id, share]) => {
        if (id in bal) bal[id] -= share;
      });
    } else if (Array.isArray(sa)) {
      // â”€â”€ Equal among selected members â”€â”€
      const valid = sa.filter(id => id in bal);
      if (!valid.length) return;
      const share = amt / valid.length;
      valid.forEach(id => { bal[id] -= share; });
    } else {
      // â”€â”€ Equal among all â”€â”€
      const share = amt / ids.length;
      ids.forEach(id => { bal[id] -= share; });
    }
    if (e.paidBy in bal) bal[e.paidBy] += amt;
  });

  ids.forEach(id => { bal[id] = Math.round(bal[id]*100)/100; });
  return bal;
}

function calcTransfers(bal) {
  const creds  = [], debts = [];
  Object.entries(bal).forEach(([id, b]) => {
    if (b >  0.01) creds.push({ id, v: b });
    if (b < -0.01) debts.push({ id, v: -b });
  });
  creds.sort((a,b) => b.v - a.v);
  debts.sort((a,b) => b.v - a.v);

  const out = [];
  let ci=0, di=0;
  while (ci < creds.length && di < debts.length) {
    const c = creds[ci], d = debts[di];
    const amt = Math.min(c.v, d.v);
    if (amt > 0.01) out.push({ from: d.id, to: c.id, amount: Math.round(amt*100)/100 });
    c.v -= amt; d.v -= amt;
    if (c.v < 0.01) ci++;
    if (d.v < 0.01) di++;
  }
  return out;
}

const ICONS = ['ğŸ•','ğŸ›’','â›½','ğŸ¨','ğŸ‰','ğŸº','â˜•','ğŸ­','ğŸ”','âœˆï¸','ğŸ–ï¸','ğŸ¸'];
function icon(str) { return ICONS[str.charCodeAt(0) % ICONS.length]; }
function fmtDate(ts) { return new Date(ts).toLocaleDateString('he-IL', { day:'numeric', month:'short' }); }

function renderExpenses() {
  const members  = groupData.members  || {};
  const expenses = groupData.expenses || {};
  const mIds     = Object.keys(members);
  const expList  = Object.entries(expenses);
  const query    = (document.getElementById('exp-search')?.value || '').trim().toLowerCase();

  const esSorted = expList
    .sort((a,b) => b[1].timestamp - a[1].timestamp)
    .filter(([,e]) => !query || (e.description||'').toLowerCase().includes(query) || (e.payerName||'').toLowerCase().includes(query) || (e.note||'').toLowerCase().includes(query));

  document.getElementById('expenses-list').innerHTML = esSorted.length
    ? esSorted.map(([id,e]) => {
        // â”€â”€ Payment item â”€â”€
        if (e.type === 'payment') {
          const amt = (e.amountILS ?? e.amount ?? 0).toFixed(2);
          return `<div class="expense-item payment-item">
            <div class="exp-icon" style="background:linear-gradient(135deg,var(--success),#34d399)">ğŸ’¸</div>
            <div class="exp-info">
              <div class="exp-desc">${e.description}</div>
              <div class="exp-meta">×”×—×–×¨×ª ×—×•×‘ &nbsp;Â·&nbsp; ${fmtDate(e.timestamp)}</div>
            </div>
            <div class="exp-amount" style="color:var(--success)">â‚ª${amt}</div>
            ${e.paidBy===myId ? `<button class="btn-ghost" onclick="deleteExpense('${id}')" title="××—×§">ğŸ—‘</button>` : ''}
          </div>`;
        }

        const isILS = !e.currency || e.currency === 'ILS';
        const amtHtml = isILS
          ? `<div class="exp-amount">â‚ª${(e.amountILS ?? e.amount ?? 0).toFixed(2)}</div>`
          : `<div class="exp-amount">${currSymbol(e.currency)}${(e.amount||0).toFixed(2)}<span class="exp-amount-orig">â‰ˆ â‚ª${(e.amountILS ?? e.amount ?? 0).toFixed(2)}</span></div>`;

        const sa = e.splitAmong;
        const splitTag = sa
          ? Array.isArray(sa)
            ? `<span class="exp-split-tag">âœ‚ï¸ ${sa.length} ××©×ª×ª×¤×™×</span>`
            : `<span class="exp-split-tag">âœ‚ï¸ ×—×œ×•×§×” ××•×ª×××ª (${Object.keys(sa).length} ×× ×©×™×)</span>`
          : '';

        // Reactions
        const reactions = e.reactions || {};
        const grouped = {};
        Object.entries(reactions).forEach(([uid, em]) => {
          grouped[em] = grouped[em] || [];
          grouped[em].push(uid);
        });
        const myReaction = reactions[myId];
        const reactionBtns = Object.entries(grouped).map(([em, uids]) =>
          `<button class="reaction-btn ${myReaction===em?'mine':''}" onclick="toggleReaction('${id}','${em}')">${em}<span class="reaction-count">${uids.length}</span></button>`
        ).join('');
        const addReactionBtns = REACTION_EMOJIS.filter(em => !grouped[em]).map(em =>
          `<button class="reaction-add" onclick="toggleReaction('${id}','${em}')" title="×”×•×¡×£ ×ª×’×•×‘×”">${em}</button>`
        ).join('');

        const isOwn = e.paidBy === myId;
        return `
        <div class="expense-item" style="flex-wrap:wrap">
          <div class="exp-icon">${icon(e.description)}</div>
          <div class="exp-info">
            <div class="exp-desc">${e.description}</div>
            <div class="exp-meta">×©×™×œ×: ${e.payerName||'?'} &nbsp;Â·&nbsp; ${fmtDate(e.timestamp)}</div>
            ${e.note ? `<div class="exp-note">ğŸ“ ${e.note}</div>` : ''}
            ${splitTag}
            <div class="reactions-row">${reactionBtns}${addReactionBtns}</div>
          </div>
          ${amtHtml}
          <div style="display:flex;flex-direction:column;gap:4px">
            ${isOwn ? `<button class="btn-ghost" onclick="editExpense('${id}')" title="×¢×¨×•×š">âœï¸</button>` : ''}
            ${isOwn ? `<button class="btn-ghost" onclick="deleteExpense('${id}')" title="××—×§">ğŸ—‘</button>` : ''}
          </div>
        </div>`;
      }).join('')
    : query
      ? `<div class="empty"><div class="empty-icon">ğŸ”</div><h3>××™×Ÿ ×ª×•×¦××•×ª</h3><p>× ×¡×” ××™×œ×” ××—×¨×ª</p></div>`
      : `<div class="empty"><div class="empty-icon">ğŸ’³</div><h3>××™×Ÿ ×”×•×¦××•×ª ×¢×“×™×™×Ÿ</h3><p>×”×•×¡×£ ××ª ×”×”×•×¦××” ×”×¨××©×•× ×”</p></div>`;
}

function render() {
  const members  = groupData.members  || {};
  const expenses = groupData.expenses || {};
  const mIds     = Object.keys(members);
  const expList  = Object.entries(expenses);

  // Closed banner
  const isClosed = !!groupData.closed;
  document.getElementById('closed-banner-el').style.display = isClosed ? 'flex' : 'none';
  document.getElementById('add-expense-form').style.display = isClosed ? 'none' : '';
  const closeBtn = document.getElementById('close-group-btn');
  if (closeBtn) closeBtn.textContent = isClosed ? 'ğŸ”“ ×¤×ª×— ××—×“×©' : 'ğŸ”’ ×¡×’×¨× ×• ×—×©×‘×•×Ÿ';

  // Group emoji
  const emojiBtn = document.getElementById('g-emoji-btn');
  if (emojiBtn) emojiBtn.textContent = groupData.emoji || 'ğŸ’¸';

  document.getElementById('g-name').textContent    = groupData.name || '';
  document.getElementById('g-code').textContent    = groupCode;
  document.getElementById('s-members').textContent = `ğŸ‘¥ ${mIds.length}`;

  const total = expList.reduce((s,[,e]) => s + (e.amountILS ?? e.amount ?? 0), 0);
  document.getElementById('s-total').textContent = 'â‚ª' + total.toFixed(2);
  document.getElementById('s-share').textContent = mIds.length ? 'â‚ª' + (total/mIds.length).toFixed(2) : 'â‚ª0';

  // My balance (always visible)
  const bal0 = calcBalances();
  const myBal = bal0[myId] ?? 0;
  const myBalEl = document.getElementById('s-mybal');
  myBalEl.textContent = (myBal >= 0 ? '+' : '') + 'â‚ª' + myBal.toFixed(2);
  myBalEl.style.color = myBal > 0.01 ? 'var(--success)' : myBal < -0.01 ? 'var(--danger)' : 'var(--text-light)';

  const sel = document.getElementById('e-paidby');
  const prev = sel.value;
  sel.innerHTML = mIds.map(id =>
    `<option value="${id}" ${id===myId?'selected':''}>${members[id].name}</option>`
  ).join('');
  if (prev && mIds.includes(prev)) sel.value = prev;

  // Refresh split members bar if open
  if (document.getElementById('e-unequal')?.checked) renderSplitMembersBar();

  document.getElementById('members-list').innerHTML = mIds.length
    ? mIds.map(id => {
        const m = members[id];
        return `<div class="member-chip">
          <div class="avatar" style="background:${avatarColor(id)};font-size:${m.avatar?'14px':'11px'}">${m.avatar||initials(m.name)}</div>
          <span>${m.name}</span>
          ${id===myId ? '<span class="me-tag">×× ×™</span>' : ''}
        </div>`;
      }).join('')
    : '<span style="font-size:13px;color:var(--text-light)">××™×Ÿ ×—×‘×¨×™× ×¢×“×™×™×Ÿ</span>';

  renderExpenses();

  const bal = calcBalances();

  // Per-member paid summary
  const paidPerMember = {};
  mIds.forEach(id => paidPerMember[id] = 0);
  expList.forEach(([,e]) => { if (e.paidBy in paidPerMember) paidPerMember[e.paidBy] += e.amountILS ?? e.amount ?? 0; });

  document.getElementById('balances-list').innerHTML = (mIds.length
    ? mIds.map(id => {
        const m = members[id];
        const b = bal[id]||0;
        const cls = b>0.01?'pos': b<-0.01?'neg':'zero';
        const sign = b>0?'+':'';
        return `<div class="balance-item">
          <div class="avatar" style="background:${avatarColor(id)};font-size:${m.avatar?'14px':'11px'}">${m.avatar||initials(m.name)}</div>
          <span class="balance-name">${m.name}${id===myId?' <span style="font-size:11px;color:var(--text-light)">(×× ×™)</span>':''}</span>
          <span class="balance-amount ${cls}">${sign}â‚ª${Math.abs(b).toFixed(2)}</span>
        </div>`;
      }).join('')
    : '<div class="empty"><div class="empty-icon">ğŸ“Š</div><h3>××™×Ÿ ×—×‘×¨×™× ×¢×“×™×™×Ÿ</h3></div>')
  + (mIds.length && expList.length ? `
    <div class="member-paid-section">
      <div class="member-paid-title">×¡×”×´×› ×©×™×œ× ×›×œ ××—×“</div>
      ${mIds.sort((a,b) => paidPerMember[b]-paidPerMember[a]).map(id => `
        <div class="member-paid-row">
          <div class="avatar" style="background:${avatarColor(id)};font-size:${members[id].avatar?'14px':'11px'};width:24px;height:24px">${members[id].avatar||initials(members[id].name)}</div>
          <span class="member-paid-name">${members[id].name}</span>
          <span class="member-paid-amt">â‚ª${paidPerMember[id].toFixed(2)}</span>
        </div>`).join('')}
    </div>` : '');

  const transfers = calcTransfers(bal);
  document.getElementById('transfers-list').innerHTML = transfers.length
    ? transfers.map(t => {
        const fName = members[t.from]?.name || '?';
        const tName = members[t.to]?.name   || '?';
        return `<div class="transfer-item">
          <div class="avatar" style="background:${avatarColor(t.from)};font-size:${members[t.from]?.avatar?'14px':'11px'}">${members[t.from]?.avatar||initials(fName)}</div>
          <span class="tr-from">${fName}</span>
          <span class="tr-arrow">â†</span>
          <div class="avatar" style="background:${avatarColor(t.to)};font-size:${members[t.to]?.avatar?'14px':'11px'}">${members[t.to]?.avatar||initials(tName)}</div>
          <span class="tr-to">${tName}</span>
          <span class="tr-amount">â‚ª${t.amount.toFixed(2)}</span>
          <div style="display:flex;flex-direction:column;gap:4px">
            <button class="tr-copy" onclick="copyReminder('${fName}','${tName}',${t.amount.toFixed(2)})" title="×”×¢×ª×§ ×ª×–×›×•×¨×ª">ğŸ“‹ ×”×¢×ª×§</button>
            <button class="tr-copy" style="background:rgba(16,185,129,.12);color:var(--success)" onclick="recordPayment('${t.from}','${t.to}',${t.amount.toFixed(2)})" title="×¡××Ÿ ×›×©×•×œ×">âœ… ×©×•×œ×</button>
          </div>
        </div>`;
      }).join('')
    : `<div class="empty"><div class="empty-icon">ğŸ‰</div><h3>${expList.length ? '×”×›×œ ×××•×–×Ÿ!' : '××™×Ÿ ×”×•×¦××•×ª ×¢×“×™×™×Ÿ'}</h3><p>${expList.length ? '××™×Ÿ ×¦×•×¨×š ×‘×”×¢×‘×¨×•×ª ×›×¨×’×¢' : '×”×•×¡×£ ×”×•×¦××•×ª ×›×“×™ ×œ×¨××•×ª ××™ ×—×™×™×‘ ×œ××™'}</p></div>`;

  // â”€â”€â”€ Log tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const logEntries = Object.values(groupData.log || {}).sort((a,b) => b.timestamp - a.timestamp);
  const deletedExpIds = new Set(logEntries.filter(e => e.type === 'delete').map(e => e.expId).filter(Boolean));
  document.getElementById('log-list').innerHTML = logEntries.length
    ? logEntries.map(entry => {
        const isDel = entry.type === 'delete';
        const wasDeleted = !isDel && deletedExpIds.has(entry.expId);
        const isILS = !entry.currency || entry.currency === 'ILS';
        const amtILS = (entry.amountILS ?? entry.amount ?? 0).toFixed(2);
        const amtOrig = (entry.amount || 0).toFixed(2);
        const amtHtml = isILS
          ? `â‚ª${amtILS}`
          : `${currSymbol(entry.currency)}${amtOrig}<span class="log-amount-orig">â‰ˆ â‚ª${amtILS}</span>`;
        return `<div class="log-item">
          <div class="log-icon ${isDel?'del-icon':'add-icon'}">${isDel?'ğŸ—‘':'â•'}</div>
          <div class="log-info">
            <div class="log-title${wasDeleted?' log-title-del':''}">${entry.description||''}</div>
            <div class="log-meta-text">${entry.actor||''} Â· ${fmtDate(entry.timestamp)} Â· ×©×™×œ×: ${entry.payerName||'?'}</div>
            ${wasDeleted ? '<div class="log-warn">âš ï¸ ×”×•×¦××” ×–×• × ××—×§×” ×œ××—×¨ ××›×Ÿ</div>' : ''}
            ${isDel ? '<div class="log-warn">×”×•×¦××” × ××—×§×”</div>' : ''}
          </div>
          <div class="log-amount ${isDel?'neg':''}">${isDel?'âˆ’':''}${amtHtml}</div>
        </div>`;
      }).join('')
    : `<div class="empty"><div class="empty-icon">ğŸ“‹</div><h3>××™×Ÿ ×¤×¢×•×œ×•×ª ×¢×“×™×™×Ÿ</h3><p>×›××Ÿ ×ª×•×¤×™×¢ ×”×™×¡×˜×•×¨×™×™×ª ×”×”×•×¦××•×ª</p></div>`;
}

// Migrate old single-session format
(function migrateLegacySession() {
  const raw = localStorage.getItem('splits_session');
  if (!raw) return;
  try {
    const { code, uid, name } = JSON.parse(raw);
    if (code && uid && name) {
      const groups = getSavedGroups();
      if (!groups.find(g => g.code === code)) {
        groups.unshift({ code, uid, myName: name, groupName: code, lastAccessed: Date.now() });
        localStorage.setItem('splits_groups', JSON.stringify(groups));
      }
    }
  } catch {}
  localStorage.removeItem('splits_session');
})();

renderAvatarPicker('ap-create', 'create');
renderAvatarPicker('ap-join', 'join');
fetchRates(); // preload exchange rates

// Handle invite link: splits.html?code=ABCDEF
(async () => {
  const inviteCode = new URLSearchParams(location.search).get('code');
  if (inviteCode) {
    // Clean the URL without reloading
    history.replaceState({}, '', location.pathname);
    // Show join tab with code pre-filled
    toggleHomeForm('join');
    document.getElementById('j-code').value = inviteCode.toUpperCase();
    document.getElementById('j-user').focus();
    // Try to fetch group name to show a banner
    try {
      const snap = await get(ref(db, `splits/${inviteCode.toUpperCase()}`));
      if (snap.exists()) {
        const gName = snap.val().name || inviteCode;
        const banner = document.createElement('div');
        banner.className = 'invite-banner';
        banner.innerHTML = `<h2>×”×•×–×× ×ª ×œ×§×‘×•×¦×”!</h2><p>×”×¦×˜×¨×£ ×œ×§×‘×•×¦×” <strong>"${gName}"</strong></p>`;
        const joinCard = document.getElementById('join-form-card');
        joinCard.parentNode.insertBefore(banner, joinCard);
      }
    } catch {}
    renderMyGroups();
    return;
  }
  renderMyGroups();
})();
</script>
</body>
</html>
