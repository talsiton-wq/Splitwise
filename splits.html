<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Splits â€“ ×—×œ×•×§×ª ×ª×©×œ×•××™×</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary:       #4f46e5;
      --primary-light: #818cf8;
      --primary-dark:  #3730a3;
      --success:       #10b981;
      --danger:        #ef4444;
      --bg:            #f1f5f9;
      --card:          #ffffff;
      --text:          #1e293b;
      --text-light:    #64748b;
      --border:        #e2e8f0;
      --shadow:        0 1px 3px rgba(0,0,0,.10), 0 1px 2px rgba(0,0,0,.06);
      --shadow-md:     0 4px 6px -1px rgba(0,0,0,.10), 0 2px 4px -1px rgba(0,0,0,.06);
      --radius:        14px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      direction: rtl;
    }

    .screen { display: none; }
    .screen.active { display: block; }

    #home-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .logo { font-size: 56px; margin-bottom: 6px; }
    .app-title { font-size: 36px; font-weight: 900; color: var(--primary); margin-bottom: 6px; letter-spacing: -1px; }
    .app-subtitle { font-size: 15px; color: var(--text-light); margin-bottom: 40px; text-align: center; }

    .home-card { background: var(--card); border-radius: var(--radius); padding: 28px 24px; width: 100%; max-width: 400px; box-shadow: var(--shadow-md); }

    .home-toggle { display: flex; background: var(--bg); border-radius: 10px; padding: 4px; margin-bottom: 24px; }
    .home-toggle button { flex: 1; padding: 9px; border: none; background: none; cursor: pointer; border-radius: 7px; font-size: 14px; font-weight: 600; color: var(--text-light); transition: all .2s; }
    .home-toggle button.active { background: var(--card); color: var(--primary); box-shadow: var(--shadow); }

    .form-group { margin-bottom: 14px; }
    label { display: block; font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 5px; }
    input, select { width: 100%; padding: 11px 14px; border: 1.5px solid var(--border); border-radius: 9px; font-size: 15px; color: var(--text); background: var(--bg); transition: border-color .2s, background .2s; direction: rtl; font-family: inherit; }
    input:focus, select:focus { outline: none; border-color: var(--primary); background: #fff; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 11px 20px; border: none; border-radius: 9px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all .18s; font-family: inherit; }
    .btn-primary  { background: var(--primary); color: #fff; width: 100%; }
    .btn-primary:hover  { background: var(--primary-dark); }
    .btn-secondary { background: var(--bg); color: var(--text); border: 1.5px solid var(--border); }
    .btn-success  { background: var(--success); color: #fff; }
    .btn-danger   { background: var(--danger);  color: #fff; }
    .btn-sm { padding: 7px 14px; font-size: 13px; }
    .btn-ghost { background: none; border: none; cursor: pointer; color: var(--text-light); padding: 6px; border-radius: 7px; font-family: inherit; transition: background .15s; }
    .btn-ghost:hover { background: var(--bg); color: var(--danger); }

    #group-screen { max-width: 620px; margin: 0 auto; padding: 14px; }

    .group-header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: #fff; border-radius: var(--radius); padding: 18px 20px; margin-bottom: 14px; display: flex; justify-content: space-between; align-items: center; }
    .group-header h1 { font-size: 20px; font-weight: 800; margin-bottom: 4px; }

    .code-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,.18); border-radius: 20px; padding: 3px 11px; font-size: 13px; font-weight: 700; letter-spacing: 1px; cursor: pointer; transition: background .15s; }
    .code-badge:hover { background: rgba(255,255,255,.28); }

    .leave-btn { background: rgba(255,255,255,.15); border: none; color: #fff; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: background .15s; font-family: inherit; }
    .leave-btn:hover { background: rgba(255,255,255,.28); }

    .summary-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 14px; }
    .summary-card { background: var(--card); border-radius: var(--radius); padding: 14px 10px; text-align: center; box-shadow: var(--shadow); }
    .summary-label { font-size: 11px; color: var(--text-light); font-weight: 600; margin-bottom: 3px; }
    .summary-value { font-size: 20px; font-weight: 800; color: var(--primary); }

    .tabs { display: flex; gap: 4px; background: var(--card); border-radius: 11px; padding: 4px; margin-bottom: 14px; box-shadow: var(--shadow); }
    .tab-btn { flex: 1; padding: 10px 6px; border: none; background: none; cursor: pointer; border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--text-light); transition: all .2s; font-family: inherit; }
    .tab-btn.active { background: var(--primary); color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .card { background: var(--card); border-radius: var(--radius); padding: 18px; margin-bottom: 12px; box-shadow: var(--shadow); }
    .card-title { font-size: 15px; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; justify-content: space-between; }

    .members-wrap { display: flex; flex-wrap: wrap; gap: 8px; }
    .member-chip { display: inline-flex; align-items: center; gap: 6px; background: var(--bg); border-radius: 20px; padding: 5px 12px 5px 6px; font-size: 13px; font-weight: 500; }
    .avatar { width: 26px; height: 26px; border-radius: 50%; background: var(--primary); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; flex-shrink: 0; }
    .me-tag { background: var(--primary); color: #fff; font-size: 10px; padding: 1px 5px; border-radius: 8px; font-weight: 700; }

    .avatar-picker-wrap { margin-top: 6px; }
    .avatar-picker-wrap label { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 7px; display: block; }
    .avatar-picker { display: flex; flex-wrap: wrap; gap: 6px; }
    .avatar-opt { width: 40px; height: 40px; border-radius: 10px; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid transparent; transition: all .15s; background: var(--bg); user-select: none; }
    .avatar-opt:hover { border-color: var(--primary-light); transform: scale(1.1); }
    .avatar-opt.selected { border-color: var(--primary); background: rgba(99,102,241,.1); box-shadow: 0 0 0 2px rgba(99,102,241,.18); transform: scale(1.08); }

    .add-member-row { display: flex; gap: 8px; margin-top: 12px; }

    .expense-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .expense-item:last-child { border-bottom: none; padding-bottom: 0; }
    .exp-icon { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .exp-info { flex: 1; min-width: 0; }
    .exp-desc { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
    .exp-meta { font-size: 12px; color: var(--text-light); }
    .exp-amount { font-size: 17px; font-weight: 800; color: var(--primary); white-space: nowrap; }

    .balance-item { display: flex; align-items: center; gap: 11px; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .balance-item:last-child { border-bottom: none; }
    .balance-name { flex: 1; font-weight: 600; font-size: 14px; }
    .balance-amount { font-size: 15px; font-weight: 800; }
    .pos { color: var(--success); }
    .neg { color: var(--danger); }
    .zero { color: var(--text-light); }

    .transfer-item { display: flex; align-items: center; gap: 10px; padding: 13px 14px; background: var(--bg); border-radius: 10px; margin-bottom: 8px; }
    .tr-from { font-weight: 700; color: var(--danger); font-size: 14px; }
    .tr-to   { font-weight: 700; color: var(--success); font-size: 14px; }
    .tr-arrow { font-size: 16px; color: var(--text-light); }
    .tr-amount { margin-right: auto; font-size: 17px; font-weight: 800; color: var(--primary); white-space: nowrap; }

    .add-form { background: var(--card); border-radius: var(--radius); padding: 18px; margin-bottom: 12px; box-shadow: var(--shadow); }
    .form-row { display: flex; gap: 10px; }
    .form-row .form-group { flex: 1; }

    .empty { text-align: center; padding: 36px 16px; color: var(--text-light); }
    .empty-icon { font-size: 44px; margin-bottom: 10px; }
    .empty h3 { font-size: 17px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
    .empty p { font-size: 13px; }

    .exp-amount { font-size: 17px; font-weight: 800; color: var(--primary); white-space: nowrap; text-align: start; }
    .exp-amount-orig { font-size: 11px; color: var(--text-light); font-weight: 600; display: block; }

    .log-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .log-item:last-child { border-bottom: none; }
    .log-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .log-icon.add-icon { background: rgba(16,185,129,.12); }
    .log-icon.del-icon { background: rgba(239,68,68,.12); }
    .log-info { flex: 1; min-width: 0; }
    .log-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .log-title-del { text-decoration: line-through; opacity: .6; }
    .log-meta-text { font-size: 12px; color: var(--text-light); }
    .log-warn { font-size: 11px; color: var(--danger); font-weight: 700; margin-top: 3px; }
    .log-amount { font-size: 14px; font-weight: 700; white-space: nowrap; }
    .log-amount-orig { font-size: 11px; color: var(--text-light); font-weight: 600; display: block; }

    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(80px); background: #1e293b; color: #fff; padding: 11px 22px; border-radius: 10px; font-size: 14px; font-weight: 600; transition: transform .3s; z-index: 999; white-space: nowrap; }
    .toast.show { transform: translateX(-50%) translateY(0); }

    .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin .7s linear infinite; margin: 40px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 480px) {
      .form-row { flex-direction: column; gap: 0; }
      .summary-row { grid-template-columns: 1fr 1fr; }
      .summary-row .summary-card:last-child { grid-column: 1 / -1; }
    }

    #my-groups-section { width: 100%; max-width: 400px; margin-top: 20px; }
    .my-groups-title { font-size: 13px; font-weight: 700; color: var(--text-light); margin-bottom: 10px; text-align: center; text-transform: uppercase; letter-spacing: .5px; }
    .saved-group-item { background: var(--card); border-radius: var(--radius); margin-bottom: 8px; box-shadow: var(--shadow); overflow: hidden; transition: box-shadow .15s; }
    .saved-group-item:hover { box-shadow: var(--shadow-md); }
    .sgi-header { display: flex; align-items: center; gap: 12px; padding: 13px 16px; cursor: pointer; user-select: none; }
    .saved-group-info { flex: 1; min-width: 0; }
    .saved-group-name { font-weight: 700; font-size: 15px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .saved-group-meta { font-size: 12px; color: var(--text-light); }
    .sgi-arrow { font-size: 13px; color: var(--text-light); transition: transform .25s; flex-shrink: 0; }
    .saved-group-item.expanded .sgi-arrow { transform: rotate(180deg); }
    .sgi-details { border-top: 1px solid var(--border); display: none; }
    .saved-group-item.expanded .sgi-details { display: block; }
    .sgi-detail-content { padding: 12px 16px 16px; }
    .sgi-stats { display: flex; gap: 6px; margin-bottom: 10px; }
    .sgi-stat { flex: 1; text-align: center; padding: 8px 4px; background: var(--bg); border-radius: 8px; }
    .sgi-stat-val { display: block; font-size: 18px; font-weight: 800; color: var(--primary); }
    .sgi-stat-lbl { font-size: 11px; color: var(--text-light); font-weight: 600; }
    .sgi-members { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
    .sgi-actions { display: flex; gap: 8px; }

    .invite-banner { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: #fff; border-radius: var(--radius); padding: 18px 20px; margin-bottom: 20px; text-align: center; }
    .invite-banner h2 { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
    .invite-banner p { font-size: 13px; opacity: .85; margin-bottom: 14px; }
  </style>
</head>
<body>

<div class="toast" id="toast"></div>

<div id="home-screen" class="screen active">
  <div class="logo">ğŸ’¸</div>
  <h1 class="app-title">Splits</h1>
  <p class="app-subtitle">×—×œ×§×• ×”×•×¦××•×ª ×‘×§×œ×•×ª ×¢× ×—×‘×¨×™× ×•××©×¤×—×”</p>

  <div class="home-card">
    <div class="home-toggle">
      <button id="ht-create" class="active" onclick="homeTab('create')">×§×‘×•×¦×” ×—×“×©×”</button>
      <button id="ht-join"                   onclick="homeTab('join')">×”×¦×˜×¨×£ ×œ×§×‘×•×¦×”</button>
    </div>

    <div id="create-tab">
      <div class="form-group">
        <label>×©× ×”×§×‘×•×¦×”</label>
        <input id="c-group" type="text" placeholder='×œ××©×œ: "×˜×™×•×œ ×œ××™×œ×ª"' maxlength="50">
      </div>
      <div class="form-group">
        <label>×”×©× ×©×œ×š</label>
        <input id="c-user" type="text" placeholder="×”×›× ×¡ ××ª ×©××š" maxlength="30">
      </div>
      <div class="form-group avatar-picker-wrap">
        <label>×”××•×•×˜××¨ ×©×œ×š</label>
        <div class="avatar-picker" id="ap-create"></div>
      </div>
      <button class="btn btn-primary" onclick="createGroup()">âœ¨ ×¦×•×¨ ×§×‘×•×¦×”</button>
    </div>

    <div id="join-tab" style="display:none">
      <div class="form-group">
        <label>×§×•×“ ×§×‘×•×¦×”</label>
        <input id="j-code" type="text" placeholder="6 ×ª×•×•×™×, ×œ××©×œ: ABC123" maxlength="6"
               oninput="this.value=this.value.toUpperCase()">
      </div>
      <div class="form-group">
        <label>×”×©× ×©×œ×š</label>
        <input id="j-user" type="text" placeholder="×”×›× ×¡ ××ª ×©××š" maxlength="30">
      </div>
      <div class="form-group avatar-picker-wrap">
        <label>×”××•×•×˜××¨ ×©×œ×š</label>
        <div class="avatar-picker" id="ap-join"></div>
      </div>
      <button class="btn btn-primary" onclick="joinGroup()">ğŸš€ ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×”</button>
    </div>
  </div>

  <div id="my-groups-section" style="display:none">
    <div class="my-groups-title">×”×§×‘×•×¦×•×ª ×©×œ×™</div>
    <div id="my-groups-list"></div>
  </div>
</div>

<div id="group-screen" class="screen">
  <div class="group-header">
    <div>
      <h1 id="g-name"></h1>
      <div class="code-badge" onclick="copyCode()" title="×œ×—×¥ ×œ×”×¢×ª×§×”">
        ğŸ“‹ <span id="g-code"></span>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-direction:column;align-items:flex-end">
      <button class="leave-btn" onclick="leaveGroup()">×™×¦×™××” â†</button>
      <button class="leave-btn" onclick="shareGroupLink()" title="×©×œ×— ×§×™×©×•×¨ ×”×¦×˜×¨×¤×•×ª">ğŸ”— ×©×ª×£ ×§×™×©×•×¨</button>
    </div>
  </div>

  <div class="summary-row">
    <div class="summary-card">
      <div class="summary-label">×¡×”×´×› ×”×•×¦××•×ª</div>
      <div class="summary-value" id="s-total">â‚ª0</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">×—×œ×§ ×œ××—×“</div>
      <div class="summary-value" id="s-share">â‚ª0</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">×”×××–×Ÿ ×©×œ×™</div>
      <div class="summary-value" id="s-mybal">â‚ª0</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('expenses')">×”×•×¦××•×ª</button>
    <button class="tab-btn"        onclick="switchTab('balances')">×™×ª×¨×•×ª</button>
    <button class="tab-btn"        onclick="switchTab('transfers')">×”×¢×‘×¨×•×ª</button>
    <button class="tab-btn"        onclick="switchTab('log')">ğŸ“‹ ×œ×•×’</button>
  </div>

  <div id="tab-expenses" class="tab-content active">
    <div class="add-form">
      <div class="card-title">×”×•×¡×£ ×”×•×¦××”</div>
      <div class="form-group">
        <label>×ª×™××•×¨</label>
        <input id="e-desc" type="text" placeholder='×œ××©×œ: "××¨×•×—×ª ×¢×¨×‘"' maxlength="60">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>×¡×›×•×</label>
          <input id="e-amount" type="number" placeholder="0.00" min="0.01" step="0.01">
        </div>
        <div class="form-group" style="max-width:100px">
          <label>××˜×‘×¢</label>
          <select id="e-currency">
            <option value="ILS">â‚ª ×©×§×œ</option>
            <option value="USD">$ ×“×•×œ×¨</option>
            <option value="EUR">â‚¬ ×™×•×¨×•</option>
            <option value="GBP">Â£ ×¤××•× ×“</option>
            <option value="JPY">Â¥ ×™×Ÿ</option>
            <option value="JOD">JD ×“×™× ×¨</option>
          </select>
        </div>
        <div class="form-group">
          <label>×©×™×œ×</label>
          <select id="e-paidby"></select>
        </div>
      </div>
      <button class="btn btn-primary" onclick="addExpense()">+ ×”×•×¡×£ ×”×•×¦××”</button>
    </div>

    <div class="card">
      <div class="card-title">×—×‘×¨×™ ×”×§×‘×•×¦×”</div>
      <div class="members-wrap" id="members-list"></div>
    </div>

    <div class="card">
      <div class="card-title">×”×™×¡×˜×•×¨×™×™×ª ×”×•×¦××•×ª</div>
      <div id="expenses-list"><div class="spinner"></div></div>
    </div>
  </div>

  <div id="tab-balances" class="tab-content">
    <div class="card">
      <div class="card-title">×™×ª×¨×•×ª × ×•×›×—×™×•×ª</div>
      <p style="font-size:12px;color:var(--text-light);margin-bottom:14px">
        ×¡×›×•× ×—×™×•×‘×™ = ×—×™×™×‘×™× ×œ×š | ×¡×›×•× ×©×œ×™×œ×™ = ××ª×” ×—×™×™×‘
      </p>
      <div id="balances-list"></div>
    </div>
  </div>

  <div id="tab-transfers" class="tab-content">
    <div class="card">
      <div class="card-title">×”×¢×‘×¨×•×ª × ×“×¨×©×•×ª</div>
      <p style="font-size:12px;color:var(--text-light);margin-bottom:14px">
        ×”××™× ×™××•× ×”×¢×‘×¨×•×ª ×œ××™×–×•×Ÿ ××œ× ×©×œ ×›×œ ×”×—×©×‘×•× ×•×ª
      </p>
      <div id="transfers-list"></div>
    </div>
  </div>

  <div id="tab-log" class="tab-content">
    <div class="card">
      <div class="card-title">×œ×•×’ ×¤×¢×•×œ×•×ª</div>
      <p style="font-size:12px;color:var(--text-light);margin-bottom:14px">
        ×”×™×¡×˜×•×¨×™×” ×©×œ ×”×•×¡×¤×•×ª ×•××—×™×§×•×ª ×”×•×¦××•×ª
      </p>
      <div id="log-list"></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp }    from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
import { getDatabase, ref, set, get, push, update, remove, onValue }
                             from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

const app = initializeApp({
  apiKey:      "AIzaSyA5psJbM4VDL5Dq3Dd3k1qoojepxtlg7OU",
  authDomain:  "coffe-a2619.firebaseapp.com",
  databaseURL: "https://coffe-a2619-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:   "coffe-a2619",
  storageBucket: "coffe-a2619.firebasestorage.app",
});
const db = getDatabase(app);

const AVATARS = ['ğŸ˜€','ğŸ˜','ğŸ¦Š','ğŸ»','ğŸ¦','ğŸ¼','ğŸ¦‹','ğŸŒŸ','ğŸ¯','ğŸš€','ğŸ¸','ğŸ„','ğŸŒˆ','ğŸ¦„','ğŸ¯','ğŸ™'];
const AVATAR_COLORS = [
  '#6366f1','#f59e0b','#10b981','#e11d48',
  '#8b5cf6','#0891b2','#f97316','#db2777',
  '#14b8a6','#65a30d','#9333ea','#ea580c',
];
const GROUP_GRADIENTS = [
  ['#6366f1','#8b5cf6'],
  ['#0ea5e9','#6366f1'],
  ['#10b981','#0ea5e9'],
  ['#f59e0b','#ef4444'],
  ['#ec4899','#8b5cf6'],
  ['#14b8a6','#6366f1'],
  ['#f97316','#ec4899'],
  ['#84cc16','#14b8a6'],
];

let selectedAvatarCreate = AVATARS[0];
let selectedAvatarJoin   = AVATARS[0];

function strHash(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) | 0;
  return Math.abs(h);
}
function avatarColor(id) {
  return AVATAR_COLORS[strHash(id) % AVATAR_COLORS.length];
}
function groupGradient(code) {
  const g = GROUP_GRADIENTS[strHash(code) % GROUP_GRADIENTS.length];
  return `linear-gradient(135deg, ${g[0]} 0%, ${g[1]} 100%)`;
}
function renderAvatarPicker(containerId, form) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const current = form === 'create' ? selectedAvatarCreate : selectedAvatarJoin;
  container.innerHTML = AVATARS.map(a =>
    `<div class="avatar-opt${a === current ? ' selected' : ''}" onclick="pickAvatar('${form}','${a}')">${a}</div>`
  ).join('');
}
window.pickAvatar = function(form, emoji) {
  if (form === 'create') selectedAvatarCreate = emoji;
  else selectedAvatarJoin = emoji;
  renderAvatarPicker(form === 'create' ? 'ap-create' : 'ap-join', form);
};

let groupCode   = null;
let myId        = null;
let myName      = null;
let groupData   = { name:'', members:{}, expenses:{}, log:{} };
let unsubscribe = null;

// â”€â”€â”€ Exchange rates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let exchangeRates = null;
let ratesFetchedAt = 0;
async function fetchRates() {
  if (exchangeRates && Date.now() - ratesFetchedAt < 3600000) return;
  try {
    const r = await fetch('https://open.er-api.com/v6/latest/ILS');
    if (!r.ok) throw new Error();
    const data = await r.json();
    if (data.result === 'success') { exchangeRates = data.rates; ratesFetchedAt = Date.now(); }
    else throw new Error();
  } catch {
    // fallback approximate rates (1 ILS = X foreign)
    exchangeRates = { ILS:1, USD:0.273, EUR:0.252, GBP:0.215, JPY:41.5, JOD:0.194 };
  }
}
function toILS(amount, currency) {
  if (!currency || currency === 'ILS') return amount;
  const rate = exchangeRates?.[currency];
  return (rate && rate !== 0) ? +(amount / rate).toFixed(4) : amount;
}
const CURR_SYMBOLS = { ILS:'â‚ª', USD:'$', EUR:'â‚¬', GBP:'Â£', JPY:'Â¥', JOD:'JD' };
function currSymbol(c) { return CURR_SYMBOLS[c] || c; }

function myUserId() {
  let id = localStorage.getItem('splits_uid');
  if (!id) {
    id = 'u_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7);
    localStorage.setItem('splits_uid', id);
  }
  return id;
}

function genCode() {
  const abc = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:6}, () => abc[Math.random()*abc.length|0]).join('');
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2800);
}

function initials(name) {
  return name.trim().split(/\s+/).map(w=>w[0]).join('').toUpperCase().slice(0,2);
}

window.homeTab = function(tab) {
  document.getElementById('ht-create').classList.toggle('active', tab==='create');
  document.getElementById('ht-join').classList.toggle('active', tab==='join');
  document.getElementById('create-tab').style.display = tab==='create' ? '' : 'none';
  document.getElementById('join-tab').style.display   = tab==='join'   ? '' : 'none';
};

window.createGroup = async function() {
  const gName = document.getElementById('c-group').value.trim();
  const uName = document.getElementById('c-user').value.trim();
  if (!gName) { toast('×× × ×”×›× ×¡ ×©× ×§×‘×•×¦×”'); return; }
  if (!uName) { toast('×× × ×”×›× ×¡ ××ª ×©××š');   return; }

  const uid = myUserId();
  let code;
  for (let i=0; i<5; i++) {
    code = genCode();
    if (!(await get(ref(db,`splits/${code}`))).exists()) break;
  }

  await set(ref(db,`splits/${code}`), {
    name: gName,
    createdAt: Date.now(),
    members: { [uid]: { name: uName, joinedAt: Date.now(), avatar: selectedAvatarCreate } }
  });

  saveGroupToList(code, uid, uName, gName);
  enterGroup(code, uid, uName);
};

window.joinGroup = async function() {
  const code  = document.getElementById('j-code').value.trim().toUpperCase();
  const uName = document.getElementById('j-user').value.trim();
  if (code.length !== 6) { toast('×§×•×“ ×—×™×™×‘ ×œ×”×™×•×ª 6 ×ª×•×•×™×'); return; }
  if (!uName)            { toast('×× × ×”×›× ×¡ ××ª ×©××š');        return; }

  try {
    const snap = await get(ref(db,`splits/${code}`));
    if (!snap.exists()) { toast('×§×‘×•×¦×” ×œ× × ××¦××” â€“ ×‘×“×•×§ ××ª ×”×§×•×“'); return; }

    const groupName = snap.val().name || code;
    const uid = myUserId();
    await update(ref(db,`splits/${code}/members/${uid}`), { name: uName, joinedAt: Date.now(), avatar: selectedAvatarJoin });

    saveGroupToList(code, uid, uName, groupName);
    enterGroup(code, uid, uName);
  } catch (err) {
    console.error('joinGroup error:', err);
    toast('×©×’×™××” ×‘×”×¦×˜×¨×¤×•×ª ×œ×§×‘×•×¦×” â€“ × ×¡×” ×©×•×‘');
  }
};

function getSavedGroups() {
  try { return JSON.parse(localStorage.getItem('splits_groups') || '[]'); }
  catch { return []; }
}

function saveGroupToList(code, uid, myName, groupName) {
  const groups = getSavedGroups().filter(g => g.code !== code);
  groups.unshift({ code, uid, myName, groupName, lastAccessed: Date.now() });
  localStorage.setItem('splits_groups', JSON.stringify(groups.slice(0, 20)));
}

let expandedGroupIdx = null;

function renderMyGroups() {
  const groups = getSavedGroups();
  const section = document.getElementById('my-groups-section');
  const list = document.getElementById('my-groups-list');
  if (!groups.length) { section.style.display = 'none'; expandedGroupIdx = null; return; }
  section.style.display = '';
  list.innerHTML = groups.map((g, i) => `
    <div class="saved-group-item ${expandedGroupIdx === i ? 'expanded' : ''}" id="sgi-${i}">
      <div class="sgi-header" onclick="toggleGroupDetails(${i})">
        <div class="avatar" style="width:38px;height:38px;font-size:14px;flex-shrink:0;background:${groupGradient(g.code)}">${initials(g.groupName||g.code)}</div>
        <div class="saved-group-info">
          <div class="saved-group-name">${g.groupName || g.code}</div>
          <div class="saved-group-meta">×”×©×ª×ª×¤×ª ×›: ${g.myName} &nbsp;Â·&nbsp; ×§×•×“: ${g.code}</div>
        </div>
        <span class="sgi-arrow">â–¼</span>
        <button class="btn btn-secondary btn-sm" onclick="removeGroupFromList(${i},event)" title="×”×¡×¨ ××”×¨×©×™××”" style="flex-shrink:0">âœ•</button>
      </div>
      <div class="sgi-details" id="sgd-${i}">
        <div class="sgi-detail-content">
          <div class="spinner" style="width:22px;height:22px;margin:10px auto;border-width:2px"></div>
        </div>
      </div>
    </div>
  `).join('');
  if (expandedGroupIdx !== null) loadGroupDetails(expandedGroupIdx);
}

window.toggleGroupDetails = function(idx) {
  expandedGroupIdx = (expandedGroupIdx === idx) ? null : idx;
  renderMyGroups();
};

async function loadGroupDetails(idx) {
  const groups = getSavedGroups();
  const g = groups[idx];
  if (!g) return;
  const detailEl = document.getElementById(`sgd-${idx}`);
  if (!detailEl) return;
  try {
    const snap = await get(ref(db, `splits/${g.code}`));
    if (!snap.exists()) {
      detailEl.innerHTML = '<div class="sgi-detail-content" style="color:var(--danger);font-size:13px">×§×‘×•×¦×” ×œ× × ××¦××” â€“ ×™×™×ª×›×Ÿ ×©× ××—×§×”</div>';
      return;
    }
    const data = snap.val();
    const members  = data.members  || {};
    const expenses = data.expenses || {};
    const mIds  = Object.keys(members);
    const total = Object.values(expenses).reduce((s,e) => s+(e.amount||0), 0);
    g.groupName = data.name || g.groupName;
    localStorage.setItem('splits_groups', JSON.stringify(groups));
    detailEl.innerHTML = `
      <div class="sgi-detail-content">
        <div class="sgi-stats">
          <div class="sgi-stat"><span class="sgi-stat-val">${mIds.length}</span><span class="sgi-stat-lbl">×—×‘×¨×™×</span></div>
          <div class="sgi-stat"><span class="sgi-stat-val">â‚ª${total.toFixed(0)}</span><span class="sgi-stat-lbl">×”×•×¦××•×ª</span></div>
          <div class="sgi-stat"><span class="sgi-stat-val">${Object.keys(expenses).length}</span><span class="sgi-stat-lbl">×¤×¢×•×œ×•×ª</span></div>
        </div>
        <div class="sgi-members">
          ${mIds.map(id=>`<div class="member-chip" style="font-size:12px;padding:3px 9px 3px 4px"><div class="avatar" style="width:22px;height:22px;font-size:${members[id].avatar?'13px':'10px'};background:${avatarColor(id)}">${members[id].avatar||initials(members[id].name)}</div>${members[id].name}</div>`).join('')}
        </div>
        <div class="sgi-actions">
          <button class="btn btn-primary" style="flex:1" onclick="enterSavedGroup(${idx})">×¤×ª×— ×§×‘×•×¦×” â†</button>
          <button class="btn btn-secondary" onclick="shareGroupLink('${g.code}')" title="×©×ª×£ ×§×™×©×•×¨ ×”×¦×˜×¨×¤×•×ª">ğŸ”— ×©×ª×£</button>
        </div>
      </div>`;
  } catch {
    detailEl.innerHTML = '<div class="sgi-detail-content" style="color:var(--danger);font-size:13px">×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™×</div>';
  }
}

window.enterSavedGroup = async function(idx) {
  const groups = getSavedGroups();
  const g = groups[idx];
  if (!g) return;
  const snap = await get(ref(db, `splits/${g.code}`));
  if (!snap.exists()) {
    toast('×§×‘×•×¦×” ×œ× × ××¦××” â€“ ×™×™×ª×›×Ÿ ×©× ××—×§×”');
    groups.splice(idx, 1);
    localStorage.setItem('splits_groups', JSON.stringify(groups));
    expandedGroupIdx = null;
    renderMyGroups();
    return;
  }
  g.groupName = snap.val().name || g.groupName;
  g.lastAccessed = Date.now();
  localStorage.setItem('splits_groups', JSON.stringify(groups));
  expandedGroupIdx = null;
  enterGroup(g.code, g.uid, g.myName);
};

window.removeGroupFromList = function(idx, e) {
  if (e && e.stopPropagation) e.stopPropagation();
  const groups = getSavedGroups();
  groups.splice(idx, 1);
  localStorage.setItem('splits_groups', JSON.stringify(groups));
  if (expandedGroupIdx === idx) expandedGroupIdx = null;
  else if (expandedGroupIdx > idx) expandedGroupIdx--;
  renderMyGroups();
};

window.shareGroupLink = function(code) {
  const c = code || groupCode;
  if (!c) return;
  const url = location.origin + location.pathname + '?code=' + c;
  navigator.clipboard.writeText(url)
    .then(() => toast('×§×™×©×•×¨ ×”×•×¢×ª×§! ×©×œ×— ××•×ª×• ×œ×—×‘×¨×™×'))
    .catch(() => toast('×§×™×©×•×¨: ' + url));
};

function enterGroup(code, uid, name) {
  groupCode = code; myId = uid; myName = name;

  document.getElementById('home-screen').classList.remove('active');
  document.getElementById('group-screen').classList.add('active');
  document.querySelector('.group-header').style.background = groupGradient(code);

  if (unsubscribe) unsubscribe();
  unsubscribe = onValue(ref(db,`splits/${code}`), snap => {
    groupData = snap.val() || {};
    if (!groupData.members)  groupData.members  = {};
    if (!groupData.expenses) groupData.expenses = {};
    if (!groupData.log)      groupData.log      = {};
    render();
  });
}

window.leaveGroup = function() {
  if (unsubscribe) { unsubscribe(); unsubscribe = null; }
  groupCode = myId = myName = null;
  document.getElementById('group-screen').classList.remove('active');
  document.getElementById('home-screen').classList.add('active');
  renderMyGroups();
};

window.copyCode = function() {
  navigator.clipboard.writeText(groupCode)
    .then(() => toast('×§×•×“ ×”×•×¢×ª×§: ' + groupCode))
    .catch(() => toast('×§×•×“: ' + groupCode));
};

window.switchTab = function(tab) {
  const order = ['expenses','balances','transfers','log'];
  document.querySelectorAll('.tab-btn').forEach((b,i) =>
    b.classList.toggle('active', order[i]===tab));
  document.querySelectorAll('.tab-content').forEach(tc =>
    tc.classList.toggle('active', tc.id === 'tab-'+tab));
};

window.addExpense = async function() {
  const desc     = document.getElementById('e-desc').value.trim();
  const amount   = parseFloat(document.getElementById('e-amount').value);
  const currency = document.getElementById('e-currency').value || 'ILS';
  const paidBy   = document.getElementById('e-paidby').value;

  if (!desc)            { toast('×× × ×”×›× ×¡ ×ª×™××•×¨');    return; }
  if (!amount || amount<=0) { toast('×× × ×”×›× ×¡ ×¡×›×•× ×ª×§×™×Ÿ'); return; }

  await fetchRates();
  const amountILS = toILS(amount, currency);
  const member = groupData.members[paidBy];
  const payerName = member?.name || '×œ× ×™×“×•×¢';

  const expRef = push(ref(db,`splits/${groupCode}/expenses`));
  await set(expRef, { description: desc, amount, currency, amountILS, paidBy, payerName, timestamp: Date.now() });
  await push(ref(db,`splits/${groupCode}/log`), {
    type: 'add', expId: expRef.key,
    description: desc, amount, currency, amountILS, payerName,
    actor: myName, timestamp: Date.now()
  });

  document.getElementById('e-desc').value   = '';
  document.getElementById('e-amount').value = '';
  toast('×”×•×¦××” × ×•×¡×¤×” âœ“');
};

window.deleteExpense = async function(expId) {
  const exp = groupData.expenses[expId];
  if (exp) {
    await push(ref(db,`splits/${groupCode}/log`), {
      type: 'delete', expId,
      description: exp.description, amount: exp.amount,
      currency: exp.currency || 'ILS', amountILS: exp.amountILS ?? exp.amount,
      payerName: exp.payerName, actor: myName, timestamp: Date.now()
    });
  }
  await remove(ref(db,`splits/${groupCode}/expenses/${expId}`));
  toast('×”×•×¦××” × ××—×§×”');
};


function calcBalances() {
  const members  = groupData.members;
  const expenses = Object.values(groupData.expenses || {});
  const ids      = Object.keys(members);
  if (!ids.length) return {};

  const total     = expenses.reduce((s,e) => s + (e.amountILS ?? e.amount ?? 0), 0);
  const fairShare = total / ids.length;

  const bal = {};
  ids.forEach(id => bal[id] = -fairShare);
  expenses.forEach(e => { if (e.paidBy in bal) bal[e.paidBy] += e.amountILS ?? e.amount ?? 0; });
  ids.forEach(id => { bal[id] = Math.round(bal[id]*100)/100; });
  return bal;
}

function calcTransfers(bal) {
  const creds  = [], debts = [];
  Object.entries(bal).forEach(([id, b]) => {
    if (b >  0.01) creds.push({ id, v: b });
    if (b < -0.01) debts.push({ id, v: -b });
  });
  creds.sort((a,b) => b.v - a.v);
  debts.sort((a,b) => b.v - a.v);

  const out = [];
  let ci=0, di=0;
  while (ci < creds.length && di < debts.length) {
    const c = creds[ci], d = debts[di];
    const amt = Math.min(c.v, d.v);
    if (amt > 0.01) out.push({ from: d.id, to: c.id, amount: Math.round(amt*100)/100 });
    c.v -= amt; d.v -= amt;
    if (c.v < 0.01) ci++;
    if (d.v < 0.01) di++;
  }
  return out;
}

const ICONS = ['ğŸ•','ğŸ›’','â›½','ğŸ¨','ğŸ‰','ğŸº','â˜•','ğŸ­','ğŸ”','âœˆï¸','ğŸ–ï¸','ğŸ¸'];
function icon(str) { return ICONS[str.charCodeAt(0) % ICONS.length]; }
function fmtDate(ts) { return new Date(ts).toLocaleDateString('he-IL', { day:'numeric', month:'short' }); }

function render() {
  const members  = groupData.members  || {};
  const expenses = groupData.expenses || {};
  const mIds     = Object.keys(members);
  const expList  = Object.entries(expenses);

  document.getElementById('g-name').textContent = groupData.name || '';
  document.getElementById('g-code').textContent = groupCode;

  const total = expList.reduce((s,[,e]) => s + (e.amountILS ?? e.amount ?? 0), 0);
  document.getElementById('s-total').textContent = 'â‚ª' + total.toFixed(2);
  document.getElementById('s-share').textContent = mIds.length ? 'â‚ª' + (total/mIds.length).toFixed(2) : 'â‚ª0';

  // My balance (always visible)
  const bal0 = calcBalances();
  const myBal = bal0[myId] ?? 0;
  const myBalEl = document.getElementById('s-mybal');
  myBalEl.textContent = (myBal >= 0 ? '+' : '') + 'â‚ª' + myBal.toFixed(2);
  myBalEl.style.color = myBal > 0.01 ? 'var(--success)' : myBal < -0.01 ? 'var(--danger)' : 'var(--text-light)';

  const sel = document.getElementById('e-paidby');
  const prev = sel.value;
  sel.innerHTML = mIds.map(id =>
    `<option value="${id}" ${id===myId?'selected':''}>${members[id].name}</option>`
  ).join('');
  if (prev && mIds.includes(prev)) sel.value = prev;

  document.getElementById('members-list').innerHTML = mIds.length
    ? mIds.map(id => {
        const m = members[id];
        return `<div class="member-chip">
          <div class="avatar" style="background:${avatarColor(id)};font-size:${m.avatar?'14px':'11px'}">${m.avatar||initials(m.name)}</div>
          <span>${m.name}</span>
          ${id===myId ? '<span class="me-tag">×× ×™</span>' : ''}
        </div>`;
      }).join('')
    : '<span style="font-size:13px;color:var(--text-light)">××™×Ÿ ×—×‘×¨×™× ×¢×“×™×™×Ÿ</span>';

  const esSorted = expList.sort((a,b) => b[1].timestamp - a[1].timestamp);
  document.getElementById('expenses-list').innerHTML = esSorted.length
    ? esSorted.map(([id,e]) => {
        const isILS = !e.currency || e.currency === 'ILS';
        const amtHtml = isILS
          ? `<div class="exp-amount">â‚ª${(e.amountILS ?? e.amount ?? 0).toFixed(2)}</div>`
          : `<div class="exp-amount">${currSymbol(e.currency)}${(e.amount||0).toFixed(2)}<span class="exp-amount-orig">â‰ˆ â‚ª${(e.amountILS ?? e.amount ?? 0).toFixed(2)}</span></div>`;
        return `
        <div class="expense-item">
          <div class="exp-icon">${icon(e.description)}</div>
          <div class="exp-info">
            <div class="exp-desc">${e.description}</div>
            <div class="exp-meta">×©×™×œ×: ${e.payerName||'?'} &nbsp;Â·&nbsp; ${fmtDate(e.timestamp)}</div>
          </div>
          ${amtHtml}
          ${e.paidBy===myId ? `<button class="btn-ghost" onclick="deleteExpense('${id}')" title="××—×§">ğŸ—‘</button>` : ''}
        </div>`;
      }).join('')
    : `<div class="empty"><div class="empty-icon">ğŸ’³</div><h3>××™×Ÿ ×”×•×¦××•×ª ×¢×“×™×™×Ÿ</h3><p>×”×•×¡×£ ××ª ×”×”×•×¦××” ×”×¨××©×•× ×”</p></div>`;

  const bal = calcBalances();
  document.getElementById('balances-list').innerHTML = mIds.length
    ? mIds.map(id => {
        const m = members[id];
        const b = bal[id]||0;
        const cls = b>0.01?'pos': b<-0.01?'neg':'zero';
        const sign = b>0?'+':'';
        return `<div class="balance-item">
          <div class="avatar" style="background:${avatarColor(id)};font-size:${m.avatar?'14px':'11px'}">${m.avatar||initials(m.name)}</div>
          <span class="balance-name">${m.name}${id===myId?' <span style="font-size:11px;color:var(--text-light)">(×× ×™)</span>':''}</span>
          <span class="balance-amount ${cls}">${sign}â‚ª${Math.abs(b).toFixed(2)}</span>
        </div>`;
      }).join('')
    : '<div class="empty"><div class="empty-icon">ğŸ“Š</div><h3>××™×Ÿ ×—×‘×¨×™× ×¢×“×™×™×Ÿ</h3></div>';

  const transfers = calcTransfers(bal);
  document.getElementById('transfers-list').innerHTML = transfers.length
    ? transfers.map(t => {
        const fName = members[t.from]?.name || '?';
        const tName = members[t.to]?.name   || '?';
        return `<div class="transfer-item">
          <div class="avatar" style="background:${avatarColor(t.from)};font-size:${members[t.from]?.avatar?'14px':'11px'}">${members[t.from]?.avatar||initials(fName)}</div>
          <span class="tr-from">${fName}</span>
          <span class="tr-arrow">â†</span>
          <div class="avatar" style="background:${avatarColor(t.to)};font-size:${members[t.to]?.avatar?'14px':'11px'}">${members[t.to]?.avatar||initials(tName)}</div>
          <span class="tr-to">${tName}</span>
          <span class="tr-amount">â‚ª${t.amount.toFixed(2)}</span>
        </div>`;
      }).join('')
    : `<div class="empty"><div class="empty-icon">ğŸ‰</div><h3>${expList.length ? '×”×›×œ ×××•×–×Ÿ!' : '××™×Ÿ ×”×•×¦××•×ª ×¢×“×™×™×Ÿ'}</h3><p>${expList.length ? '××™×Ÿ ×¦×•×¨×š ×‘×”×¢×‘×¨×•×ª ×›×¨×’×¢' : '×”×•×¡×£ ×”×•×¦××•×ª ×›×“×™ ×œ×¨××•×ª ××™ ×—×™×™×‘ ×œ××™'}</p></div>`;

  // â”€â”€â”€ Log tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const logEntries = Object.values(groupData.log || {}).sort((a,b) => b.timestamp - a.timestamp);
  const deletedExpIds = new Set(logEntries.filter(e => e.type === 'delete').map(e => e.expId).filter(Boolean));
  document.getElementById('log-list').innerHTML = logEntries.length
    ? logEntries.map(entry => {
        const isDel = entry.type === 'delete';
        const wasDeleted = !isDel && deletedExpIds.has(entry.expId);
        const isILS = !entry.currency || entry.currency === 'ILS';
        const amtILS = (entry.amountILS ?? entry.amount ?? 0).toFixed(2);
        const amtOrig = (entry.amount || 0).toFixed(2);
        const amtHtml = isILS
          ? `â‚ª${amtILS}`
          : `${currSymbol(entry.currency)}${amtOrig}<span class="log-amount-orig">â‰ˆ â‚ª${amtILS}</span>`;
        return `<div class="log-item">
          <div class="log-icon ${isDel?'del-icon':'add-icon'}">${isDel?'ğŸ—‘':'â•'}</div>
          <div class="log-info">
            <div class="log-title${wasDeleted?' log-title-del':''}">${entry.description||''}</div>
            <div class="log-meta-text">${entry.actor||''} Â· ${fmtDate(entry.timestamp)} Â· ×©×™×œ×: ${entry.payerName||'?'}</div>
            ${wasDeleted ? '<div class="log-warn">âš ï¸ ×”×•×¦××” ×–×• × ××—×§×” ×œ××—×¨ ××›×Ÿ</div>' : ''}
            ${isDel ? '<div class="log-warn">×”×•×¦××” × ××—×§×”</div>' : ''}
          </div>
          <div class="log-amount ${isDel?'neg':''}">${isDel?'âˆ’':''}${amtHtml}</div>
        </div>`;
      }).join('')
    : `<div class="empty"><div class="empty-icon">ğŸ“‹</div><h3>××™×Ÿ ×¤×¢×•×œ×•×ª ×¢×“×™×™×Ÿ</h3><p>×›××Ÿ ×ª×•×¤×™×¢ ×”×™×¡×˜×•×¨×™×™×ª ×”×”×•×¦××•×ª</p></div>`;
}

// Migrate old single-session format
(function migrateLegacySession() {
  const raw = localStorage.getItem('splits_session');
  if (!raw) return;
  try {
    const { code, uid, name } = JSON.parse(raw);
    if (code && uid && name) {
      const groups = getSavedGroups();
      if (!groups.find(g => g.code === code)) {
        groups.unshift({ code, uid, myName: name, groupName: code, lastAccessed: Date.now() });
        localStorage.setItem('splits_groups', JSON.stringify(groups));
      }
    }
  } catch {}
  localStorage.removeItem('splits_session');
})();

renderAvatarPicker('ap-create', 'create');
renderAvatarPicker('ap-join', 'join');
fetchRates(); // preload exchange rates

// Handle invite link: splits.html?code=ABCDEF
(async () => {
  const inviteCode = new URLSearchParams(location.search).get('code');
  if (inviteCode) {
    // Clean the URL without reloading
    history.replaceState({}, '', location.pathname);
    // Show join tab with code pre-filled
    homeTab('join');
    document.getElementById('j-code').value = inviteCode.toUpperCase();
    document.getElementById('j-user').focus();
    // Try to fetch group name to show a banner
    try {
      const snap = await get(ref(db, `splits/${inviteCode.toUpperCase()}`));
      if (snap.exists()) {
        const gName = snap.val().name || inviteCode;
        const banner = document.createElement('div');
        banner.className = 'invite-banner';
        banner.innerHTML = `<h2>×”×•×–×× ×ª ×œ×§×‘×•×¦×”!</h2><p>×”×¦×˜×¨×£ ×œ×§×‘×•×¦×” <strong>"${gName}"</strong></p>`;
        const homeCard = document.querySelector('.home-card');
        homeCard.parentNode.insertBefore(banner, homeCard);
      }
    } catch {}
    renderMyGroups();
    return;
  }
  renderMyGroups();
})();
</script>
</body>
</html>
